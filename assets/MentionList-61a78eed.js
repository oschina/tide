import{c as Q,ai as $,aj as j,ak as K,al as N,am as B,an as X,ao as Y,P as A,a as q,ap as ee,E as te,aq as ne,ae as re,ar as se,as as ie,at as oe,d as ae}from"./TextBubbleMenu-7546d244.js";import{j as le,F as z,a as g}from"./jsx-runtime-c78ff179.js";import{R as S,r as m}from"./index-0dd5bd88.js";import{r as ue,R as de}from"./index-720ea98b.js";class Se extends Q{constructor(){super(...arguments),this.contentComponent=null}}const ce=({renderers:r})=>g(z,{children:Object.entries(r).map(([e,t])=>de.createPortal(t.reactElement,t.element,e))});class pe extends S.Component{constructor(e){super(e),this.editorContentRef=S.createRef(),this.initialized=!1,this.state={renderers:{}}}componentDidMount(){this.init()}componentDidUpdate(){this.init()}init(){const{editor:e}=this.props;if(e&&e.options.element){if(e.contentComponent)return;const t=this.editorContentRef.current;t.append(...e.options.element.childNodes),e.setOptions({element:t}),e.contentComponent=this,e.createNodeViews(),this.initialized=!0}}maybeFlushSync(e){this.initialized?queueMicrotask(()=>{ue.exports.flushSync(e)}):e()}setRenderer(e,t){this.maybeFlushSync(()=>{this.setState(({renderers:n})=>({renderers:{...n,[e]:t}}))})}removeRenderer(e){this.maybeFlushSync(()=>{this.setState(({renderers:t})=>{const n={...t};return delete n[e],{renderers:n}})})}componentWillUnmount(){const{editor:e}=this.props;if(!e||(this.initialized=!1,e.isDestroyed||e.view.setProps({nodeViews:{}}),e.contentComponent=null,!e.options.element.firstChild))return;const t=document.createElement("div");t.append(...e.options.element.childNodes),e.setOptions({element:t})}render(){const{editor:e,...t}=this.props;return le(z,{children:[g("div",{ref:this.editorContentRef,...t}),g(ce,{renderers:this.state.renderers})]})}}const Ae=S.memo(pe);function fe(){const[,r]=m.exports.useState(0);return()=>r(e=>e+1)}const He=(r,e={},t=[])=>{const[n,s]=m.exports.useState(null),i=fe(),{onBeforeCreate:o,onBlur:a,onCreate:l,onDestroy:c,onFocus:u,onSelectionUpdate:d,onTransaction:p,onUpdate:f}=e,y=m.exports.useRef(o),b=m.exports.useRef(a),E=m.exports.useRef(l),H=m.exports.useRef(c),O=m.exports.useRef(u),L=m.exports.useRef(d),_=m.exports.useRef(p),D=m.exports.useRef(f);return m.exports.useEffect(()=>{!n||(o&&(n.off("beforeCreate",y.current),n.on("beforeCreate",o),y.current=o),a&&(n.off("blur",b.current),n.on("blur",a),b.current=a),l&&(n.off("create",E.current),n.on("create",l),E.current=l),c&&(n.off("destroy",H.current),n.on("destroy",c),H.current=c),u&&(n.off("focus",O.current),n.on("focus",u),O.current=u),d&&(n.off("selectionUpdate",L.current),n.on("selectionUpdate",d),L.current=d),p&&(n.off("transaction",_.current),n.on("transaction",p),_.current=p),f&&(n.off("update",D.current),n.on("update",f),D.current=f))},[o,a,l,c,u,d,p,f,n]),m.exports.useEffect(()=>{let k=!0;const C=new r(e);return s(C),C.on("transaction",()=>{requestAnimationFrame(()=>{requestAnimationFrame(()=>{k&&i()})})}),()=>{C.destroy(),k=!1}},t),n},Oe=({className:r,style:e,title:t})=>{const{editor:n,statusMap:s}=$(()=>({disabled:()=>!n.can().chain().focus().redo().run()}));return g(j,{className:r,style:e,children:g(K,{text:t||`重做 (${N} + Shift + Z)`,children:g(B,{onClick:()=>n.chain().focus().redo().run(),disabled:s==null?void 0:s.disabled,children:g(X,{})})})})},Le=({className:r,style:e,title:t})=>{const{editor:n,statusMap:s}=$(()=>({disabled:()=>!n.can().chain().focus().undo().run()}));return g(j,{className:r,style:e,children:g(K,{text:t||`撤销 (${N} + Z)`,children:g(B,{onClick:()=>{var i,o;return(o=n==null?void 0:(i=n.chain().focus()).undo)==null?void 0:o.call(i).run()},disabled:s==null?void 0:s.disabled,children:g(Y,{})})})})};var x=200,h=function(){};h.prototype.append=function(e){return e.length?(e=h.from(e),!this.length&&e||e.length<x&&this.leafAppend(e)||this.length<x&&e.leafPrepend(this)||this.appendInner(e)):this};h.prototype.prepend=function(e){return e.length?h.from(e).append(this):this};h.prototype.appendInner=function(e){return new he(this,e)};h.prototype.slice=function(e,t){return e===void 0&&(e=0),t===void 0&&(t=this.length),e>=t?h.empty:this.sliceInner(Math.max(0,e),Math.min(this.length,t))};h.prototype.get=function(e){if(!(e<0||e>=this.length))return this.getInner(e)};h.prototype.forEach=function(e,t,n){t===void 0&&(t=0),n===void 0&&(n=this.length),t<=n?this.forEachInner(e,t,n,0):this.forEachInvertedInner(e,t,n,0)};h.prototype.map=function(e,t,n){t===void 0&&(t=0),n===void 0&&(n=this.length);var s=[];return this.forEach(function(i,o){return s.push(e(i,o))},t,n),s};h.from=function(e){return e instanceof h?e:e&&e.length?new G(e):h.empty};var G=function(r){function e(n){r.call(this),this.values=n}r&&(e.__proto__=r),e.prototype=Object.create(r&&r.prototype),e.prototype.constructor=e;var t={length:{configurable:!0},depth:{configurable:!0}};return e.prototype.flatten=function(){return this.values},e.prototype.sliceInner=function(s,i){return s==0&&i==this.length?this:new e(this.values.slice(s,i))},e.prototype.getInner=function(s){return this.values[s]},e.prototype.forEachInner=function(s,i,o,a){for(var l=i;l<o;l++)if(s(this.values[l],a+l)===!1)return!1},e.prototype.forEachInvertedInner=function(s,i,o,a){for(var l=i-1;l>=o;l--)if(s(this.values[l],a+l)===!1)return!1},e.prototype.leafAppend=function(s){if(this.length+s.length<=x)return new e(this.values.concat(s.flatten()))},e.prototype.leafPrepend=function(s){if(this.length+s.length<=x)return new e(s.flatten().concat(this.values))},t.length.get=function(){return this.values.length},t.depth.get=function(){return 0},Object.defineProperties(e.prototype,t),e}(h);h.empty=new G([]);var he=function(r){function e(t,n){r.call(this),this.left=t,this.right=n,this.length=t.length+n.length,this.depth=Math.max(t.depth,n.depth)+1}return r&&(e.__proto__=r),e.prototype=Object.create(r&&r.prototype),e.prototype.constructor=e,e.prototype.flatten=function(){return this.left.flatten().concat(this.right.flatten())},e.prototype.getInner=function(n){return n<this.left.length?this.left.get(n):this.right.get(n-this.left.length)},e.prototype.forEachInner=function(n,s,i,o){var a=this.left.length;if(s<a&&this.left.forEachInner(n,s,Math.min(i,a),o)===!1||i>a&&this.right.forEachInner(n,Math.max(s-a,0),Math.min(this.length,i)-a,o+a)===!1)return!1},e.prototype.forEachInvertedInner=function(n,s,i,o){var a=this.left.length;if(s>a&&this.right.forEachInvertedInner(n,s-a,Math.max(i,a)-a,o+a)===!1||i<a&&this.left.forEachInvertedInner(n,Math.min(s,a),i,o)===!1)return!1},e.prototype.sliceInner=function(n,s){if(n==0&&s==this.length)return this;var i=this.left.length;return s<=i?this.left.slice(n,s):n>=i?this.right.slice(n-i,s-i):this.left.slice(n,i).append(this.right.slice(0,s-i))},e.prototype.leafAppend=function(n){var s=this.right.leafAppend(n);if(s)return new e(this.left,s)},e.prototype.leafPrepend=function(n){var s=this.left.leafPrepend(n);if(s)return new e(s,this.right)},e.prototype.appendInner=function(n){return this.left.depth>=Math.max(this.right.depth,n.depth)+1?new e(this.left,new e(this.right,n)):new e(this,n)},e}(h),V=h;const me=500;class v{constructor(e,t){this.items=e,this.eventCount=t}popEvent(e,t){if(this.eventCount==0)return null;let n=this.items.length;for(;;n--)if(this.items.get(n-1).selection){--n;break}let s,i;t&&(s=this.remapping(n,this.items.length),i=s.maps.length);let o=e.tr,a,l,c=[],u=[];return this.items.forEach((d,p)=>{if(!d.step){s||(s=this.remapping(n,p+1),i=s.maps.length),i--,u.push(d);return}if(s){u.push(new w(d.map));let f=d.step.map(s.slice(i)),y;f&&o.maybeStep(f).doc&&(y=o.mapping.maps[o.mapping.maps.length-1],c.push(new w(y,void 0,void 0,c.length+u.length))),i--,y&&s.appendMap(y,i)}else o.maybeStep(d.step);if(d.selection)return a=s?d.selection.map(s.slice(i)):d.selection,l=new v(this.items.slice(0,n).append(u.reverse().concat(c)),this.eventCount-1),!1},this.items.length,0),{remaining:l,transform:o,selection:a}}addTransform(e,t,n,s){let i=[],o=this.eventCount,a=this.items,l=!s&&a.length?a.get(a.length-1):null;for(let u=0;u<e.steps.length;u++){let d=e.steps[u].invert(e.docs[u]),p=new w(e.mapping.maps[u],d,t),f;(f=l&&l.merge(p))&&(p=f,u?i.pop():a=a.slice(0,a.length-1)),i.push(p),t&&(o++,t=void 0),s||(l=p)}let c=o-n.depth;return c>ve&&(a=ge(a,c),o-=c),new v(a.append(i),o)}remapping(e,t){let n=new ee;return this.items.forEach((s,i)=>{let o=s.mirrorOffset!=null&&i-s.mirrorOffset>=e?n.maps.length-s.mirrorOffset:void 0;n.appendMap(s.map,o)},e,t),n}addMaps(e){return this.eventCount==0?this:new v(this.items.append(e.map(t=>new w(t))),this.eventCount)}rebased(e,t){if(!this.eventCount)return this;let n=[],s=Math.max(0,this.items.length-t),i=e.mapping,o=e.steps.length,a=this.eventCount;this.items.forEach(p=>{p.selection&&a--},s);let l=t;this.items.forEach(p=>{let f=i.getMirror(--l);if(f==null)return;o=Math.min(o,f);let y=i.maps[f];if(p.step){let b=e.steps[f].invert(e.docs[f]),E=p.selection&&p.selection.map(i.slice(l+1,f));E&&a++,n.push(new w(y,b,E))}else n.push(new w(y))},s);let c=[];for(let p=t;p<o;p++)c.push(new w(i.maps[p]));let u=this.items.slice(0,s).append(c).append(n),d=new v(u,a);return d.emptyItemCount()>me&&(d=d.compress(this.items.length-n.length)),d}emptyItemCount(){let e=0;return this.items.forEach(t=>{t.step||e++}),e}compress(e=this.items.length){let t=this.remapping(0,e),n=t.maps.length,s=[],i=0;return this.items.forEach((o,a)=>{if(a>=e)s.push(o),o.selection&&i++;else if(o.step){let l=o.step.map(t.slice(n)),c=l&&l.getMap();if(n--,c&&t.appendMap(c,n),l){let u=o.selection&&o.selection.map(t.slice(n));u&&i++;let d=new w(c.invert(),l,u),p,f=s.length-1;(p=s.length&&s[f].merge(d))?s[f]=p:s.push(d)}}else o.map&&n--},this.items.length,0),new v(V.from(s.reverse()),i)}}v.empty=new v(V.empty,0);function ge(r,e){let t;return r.forEach((n,s)=>{if(n.selection&&e--==0)return t=s,!1}),r.slice(t)}class w{constructor(e,t,n,s){this.map=e,this.step=t,this.selection=n,this.mirrorOffset=s}merge(e){if(this.step&&e.step&&!e.selection){let t=e.step.merge(this.step);if(t)return new w(t.getMap().invert(),t,this.selection)}}}class M{constructor(e,t,n,s){this.done=e,this.undone=t,this.prevRanges=n,this.prevTime=s}}const ve=20;function ye(r,e,t,n){let s=t.getMeta(I),i;if(s)return s.historyState;t.getMeta(Me)&&(r=new M(r.done,r.undone,null,0));let o=t.getMeta("appendedTransaction");if(t.steps.length==0)return r;if(o&&o.getMeta(I))return o.getMeta(I).redo?new M(r.done.addTransform(t,void 0,n,R(e)),r.undone,U(t.mapping.maps[t.steps.length-1]),r.prevTime):new M(r.done,r.undone.addTransform(t,void 0,n,R(e)),null,r.prevTime);if(t.getMeta("addToHistory")!==!1&&!(o&&o.getMeta("addToHistory")===!1)){let a=r.prevTime==0||!o&&(r.prevTime<(t.time||0)-n.newGroupDelay||!we(t,r.prevRanges)),l=o?T(r.prevRanges,t.mapping):U(t.mapping.maps[t.steps.length-1]);return new M(r.done.addTransform(t,a?e.selection.getBookmark():void 0,n,R(e)),v.empty,l,t.time)}else return(i=t.getMeta("rebased"))?new M(r.done.rebased(t,i),r.undone.rebased(t,i),T(r.prevRanges,t.mapping),r.prevTime):new M(r.done.addMaps(t.mapping.maps),r.undone.addMaps(t.mapping.maps),T(r.prevRanges,t.mapping),r.prevTime)}function we(r,e){if(!e)return!1;if(!r.docChanged)return!0;let t=!1;return r.mapping.maps[0].forEach((n,s)=>{for(let i=0;i<e.length;i+=2)n<=e[i+1]&&s>=e[i]&&(t=!0)}),t}function U(r){let e=[];return r.forEach((t,n,s,i)=>e.push(s,i)),e}function T(r,e){if(!r)return null;let t=[];for(let n=0;n<r.length;n+=2){let s=e.map(r[n],1),i=e.map(r[n+1],-1);s<=i&&t.push(s,i)}return t}function W(r,e,t,n){let s=R(e),i=I.get(e).spec.config,o=(n?r.undone:r.done).popEvent(e,s);if(!o)return;let a=o.selection.resolve(o.transform.doc),l=(n?r.done:r.undone).addTransform(o.transform,e.selection.getBookmark(),i,s),c=new M(n?l:o.remaining,n?o.remaining:l,null,0);t(o.transform.setSelection(a).setMeta(I,{redo:n,historyState:c}).scrollIntoView())}let P=!1,F=null;function R(r){let e=r.plugins;if(F!=e){P=!1,F=e;for(let t=0;t<e.length;t++)if(e[t].spec.historyPreserveItems){P=!0;break}}return P}const I=new A("history"),Me=new A("closeHistory");function Ie(r={}){return r={depth:r.depth||100,newGroupDelay:r.newGroupDelay||500},new q({key:I,state:{init(){return new M(v.empty,v.empty,null,0)},apply(e,t,n){return ye(t,n,e,r)}},config:r,props:{handleDOMEvents:{beforeinput(e,t){let n=t.inputType,s=n=="historyUndo"?Z:n=="historyRedo"?J:null;return s?(t.preventDefault(),s(e.state,e.dispatch)):!1}}}})}const Z=(r,e)=>{let t=I.getState(r);return!t||t.done.eventCount==0?!1:(e&&W(t,r,e,!1),!0)},J=(r,e)=>{let t=I.getState(r);return!t||t.undone.eventCount==0?!1:(e&&W(t,r,e,!0),!0)},_e=te.create({name:"history",addOptions(){return{depth:100,newGroupDelay:500}},addCommands(){return{undo:()=>({state:r,dispatch:e})=>Z(r,e),redo:()=>({state:r,dispatch:e})=>J(r,e)}},addProseMirrorPlugins(){return[Ie(this.options)]},addKeyboardShortcuts(){return{"Mod-z":()=>this.editor.commands.undo(),"Mod-y":()=>this.editor.commands.redo(),"Shift-Mod-z":()=>this.editor.commands.redo(),"Mod-я":()=>this.editor.commands.undo(),"Shift-Mod-я":()=>this.editor.commands.redo()}}}),Ee=new A("mention"),be=ne.create({name:"mention",addOptions(){return{HTMLAttributes:{},renderLabel({options:r,node:e}){var t;return`${r.suggestion.char}${(t=e.attrs.label)!==null&&t!==void 0?t:e.attrs.id}`},suggestion:{char:"@",pluginKey:Ee,command:({editor:r,range:e,props:t})=>{var n,s;const i=r.view.state.selection.$to.nodeAfter;((n=i==null?void 0:i.text)===null||n===void 0?void 0:n.startsWith(" "))&&(e.to+=1),r.chain().focus().insertContentAt(e,[{type:this.name,attrs:t},{type:"text",text:" "}]).run(),(s=window.getSelection())===null||s===void 0||s.collapseToEnd()},allow:({state:r,range:e})=>{const t=r.doc.resolve(e.from),n=r.schema.nodes[this.name];return!!t.parent.type.contentMatch.matchType(n)}}}},group:"inline",inline:!0,selectable:!1,atom:!0,addAttributes(){return{id:{default:null,parseHTML:r=>r.getAttribute("data-id"),renderHTML:r=>r.id?{"data-id":r.id}:{}},label:{default:null,parseHTML:r=>r.getAttribute("data-label"),renderHTML:r=>r.label?{"data-label":r.label}:{}}}},parseHTML(){return[{tag:`span[data-type="${this.name}"]`}]},renderHTML({node:r,HTMLAttributes:e}){return["span",re({"data-type":this.name},this.options.HTMLAttributes,e),this.options.renderLabel({options:this.options,node:r})]},renderText({node:r}){return this.options.renderLabel({options:this.options,node:r})},addKeyboardShortcuts(){return{Backspace:()=>this.editor.commands.command(({tr:r,state:e})=>{let t=!1;const{selection:n}=e,{empty:s,anchor:i}=n;return s?(e.doc.nodesBetween(i-1,i,(o,a)=>{if(o.type.name===this.name)return t=!0,r.insertText(this.options.suggestion.char||"",a,a+o.nodeSize),!1}),t):!1})}},addProseMirrorPlugins(){return[se({editor:this.editor,...this.options.suggestion})]}}),De=be.extend({name:"mention",group:"inline",inline:!0,selectable:!1,atom:!0,addOptions(){var e;const r=(e=this.parent)==null?void 0:e.call(this);return{...r,HTMLAttributes:{...r==null?void 0:r.HTMLAttributes,class:"mention"}}}}),ke=({component:r,componentProps:e,tippyOptions:t,...n})=>({render:()=>{let i,o;return{onStart:a=>{i=new ie(r,{props:{...a,...e},editor:a.editor}),a.clientRect&&(o=oe("body",{getReferenceClientRect:a.clientRect,appendTo:()=>a.editor.options.element,content:i.element,showOnCreate:!0,interactive:!0,trigger:"manual",placement:"bottom-start",...t}))},onUpdate(a){var l;i==null||i.updateProps(a),a.clientRect&&((l=o==null?void 0:o[0])==null||l.setProps({getReferenceClientRect:a.clientRect}))},onKeyDown(a){var l,c;return a.event.key==="Escape"?((l=o==null?void 0:o[0])==null||l.hide(),i==null||i.destroy(),!0):!!((c=i==null?void 0:i.ref)!=null&&c.onKeyDown(a))},onExit(){var a;(a=o==null?void 0:o[0])==null||a.destroy(),i==null||i.destroy()}}},...n}),Re=m.exports.forwardRef((r,e)=>{var c;const[t,n]=m.exports.useState(0),s=u=>{const d=r.items[u];d&&r.command(d.attrs)},i=()=>{n((t+r.items.length-1)%r.items.length)},o=()=>{n((t+1)%r.items.length)},a=u=>{n(u)},l=()=>{s(t)};return m.exports.useEffect(()=>n(0),[r.items]),m.exports.useImperativeHandle(e,()=>({onKeyDown:({event:u})=>u.key==="ArrowUp"?(i(),!0):u.key==="ArrowDown"?(o(),!0):u.key==="Enter"?(l(),!0):!1})),g("div",{className:"gwe-dropdown-menu",children:g("div",{className:"gwe-dropdown-menu__content",children:r.items.length?r.items.map((u,d)=>{var p;return g("div",{className:ae("gwe-dropdown-menu__item","gwe-items-between",{"gwe-dropdown-menu__item--active":d===t}),onClick:()=>s(d),onMouseOver:()=>a(d),children:(p=r.itemRender)==null?void 0:p.call(r,u)},u.id||d)}):g("div",{className:"gwe-dropdown-menu__item",children:((c=r.emptyRender)==null?void 0:c.call(r))||"没有结果"})})})});Re.displayName="MentionList";export{Se as E,_e as H,De as M,Oe as R,Le as U,Re as a,ke as b,Ae as c,He as u};
