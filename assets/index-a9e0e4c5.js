import{j as At,a as C}from"./jsx-runtime-c78ff179.js";import{P as Hn,a as Jn,S as be,F as Se,T as Bi,D as _s,b as As,E as wr,c as Pi,M as Fi,d as ji,H as zi,B as Hi,I as Ji,e as qi,C as Yi,f as ke,g as Gi,O as Wi,h as Ki,L as Xi,i as Qi,j as Zi,k as to,l as eo,m as no,n as so,o as ro,p as io,q as oo,r as co,s as lo,t as ao,u as ho,v as uo,w as fo,x as go,y as po,z as mo,A as wo,G as yo,J as bo,K as So,N as ko,Q as Co,R as _o,U as Ao,V as Do,W as Eo,X as To,Y as Io,Z as Uo,_ as vo,$ as Mo,a0 as xo,a1 as Oo,a2 as Lo,a3 as Ro,a4 as $o,a5 as No,a6 as Vo,a7 as Bo,a8 as Po,a9 as Fo,aa as jo,ab as zo,ac as Ho}from"./TextBubbleMenu-7546d244.js";import{R as z,r as E}from"./index-0dd5bd88.js";import{r as Jo,R as qo}from"./index-720ea98b.js";import{b as Yo}from"./utils-3d1031d5.js";const F=()=>new Map,Sn=e=>{const t=F();return e.forEach((n,s)=>{t.set(s,n)}),t},ct=(e,t,n)=>{let s=e.get(t);return s===void 0&&e.set(t,s=n()),s},Go=(e,t)=>{const n=[];for(const[s,r]of e)n.push(t(r,s));return n},Wo=(e,t)=>{for(const[n,s]of e)if(t(s,n))return!0;return!1},wt=()=>new Set,cn=e=>e[e.length-1],Ko=(e,t)=>{for(let n=0;n<t.length;n++)e.push(t[n])},dt=Array.from,Xo=(e,t)=>{for(let n=0;n<e.length;n++)if(t(e[n],n,e))return!0;return!1},kn=Array.isArray;let yr=class{constructor(){this._observers=F()}on(t,n){ct(this._observers,t,wt).add(n)}once(t,n){const s=(...r)=>{this.off(t,s),n(...r)};this.on(t,s)}off(t,n){const s=this._observers.get(t);s!==void 0&&(s.delete(n),s.size===0&&this._observers.delete(t))}emit(t,n){return dt((this._observers.get(t)||F()).values()).forEach(s=>s(...n))}destroy(){this._observers=F()}};const rt=Math.floor,Te=Math.abs,gt=(e,t)=>e<t?e:t,it=(e,t)=>e>t?e:t,br=e=>e!==0?e<0:1/e<0,Qo=e=>e.toLowerCase(),Zo=/^\s*/g,tc=e=>e.replace(Zo,""),ec=/([A-Z])/g,Ds=(e,t)=>tc(e.replace(ec,n=>`${t}${Qo(n)}`)),nc=e=>{const t=unescape(encodeURIComponent(e)),n=t.length,s=new Uint8Array(n);for(let r=0;r<n;r++)s[r]=t.codePointAt(r);return s},Kt=typeof TextEncoder<"u"?new TextEncoder:null,sc=e=>Kt.encode(e),rc=Kt?sc:nc;let Ht=typeof TextDecoder>"u"?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});Ht&&Ht.decode(new Uint8Array).length===1&&(Ht=null);const Es=e=>e===void 0?null:e;let ic=class{constructor(){this.map=new Map}setItem(t,n){this.map.set(t,n)}getItem(t){return this.map.get(t)}},Sr=new ic,oc=!0;try{typeof localStorage<"u"&&(Sr=localStorage,oc=!1)}catch{}const cc=Sr,lc=Object.assign,kr=Object.keys,ac=(e,t)=>{for(const n in e)t(e[n],n)},Ts=e=>kr(e).length,hc=e=>{for(const t in e)return!1;return!0},uc=(e,t)=>{for(const n in e)if(!t(e[n],n))return!1;return!0},dc=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),fc=(e,t)=>e===t||Ts(e)===Ts(t)&&uc(e,(n,s)=>(n!==void 0||dc(t,s))&&t[s]===n),qn=(e,t,n=0)=>{try{for(;n<e.length;n++)e[n](...t)}finally{n<e.length&&qn(e,t,n+1)}},gc=e=>e;const pc=(e,t)=>t.includes(e),xt=typeof process<"u"&&process.release&&/node|io\.js/.test(process.release.name),mc=typeof window<"u"&&typeof document<"u"&&!xt;let G;const wc=()=>{if(G===void 0)if(xt){G=F();const e=process.argv;let t=null;for(let n=0;n<e.length;n++){const s=e[n];s[0]==="-"?(t!==null&&G.set(t,""),t=s):t!==null&&(G.set(t,s),t=null)}t!==null&&G.set(t,"")}else typeof location=="object"?(G=F(),(location.search||"?").slice(1).split("&").forEach(e=>{if(e.length!==0){const[t,n]=e.split("=");G.set(`--${Ds(t,"-")}`,n),G.set(`-${Ds(t,"-")}`,n)}})):G=F();return G},Cn=e=>wc().has(e),_n=e=>Es(xt?process.env[e.toUpperCase()]:cc.getItem(e)),yc=e=>Cn("--"+e)||_n(e)!==null;yc("production");const Is=xt&&pc({}.FORCE_COLOR,["true","1","2"]),bc=!Cn("no-colors")&&(!xt||process.stdout.isTTY||Is)&&(!xt||Cn("color")||Is||_n("COLORTERM")!==null||(_n("TERM")||"").includes("color")),Us=1,vs=2,ln=4,an=8,Xt=32,st=64,N=128,We=31,An=63,pt=127,Sc=2147483647,Cr=Number.MAX_SAFE_INTEGER,kc=Number.isInteger||(e=>typeof e=="number"&&isFinite(e)&&rt(e)===e),Nt=e=>new Error(e),H=()=>{throw Nt("Method unimplemented")},j=()=>{throw Nt("Unexpected case")},_r=Nt("Unexpected end of array"),Ar=Nt("Integer out of Range");let Ke=class{constructor(t){this.arr=t,this.pos=0}};const Vt=e=>new Ke(e),Cc=e=>e.pos!==e.arr.length,_c=(e,t)=>{const n=Wn(e.arr.buffer,e.pos+e.arr.byteOffset,t);return e.pos+=t,n},R=e=>_c(e,w(e)),Ot=e=>e.arr[e.pos++],w=e=>{let t=0,n=1;const s=e.arr.length;for(;e.pos<s;){const r=e.arr[e.pos++];if(t=t+(r&pt)*n,n*=128,r<N)return t;if(t>Cr)throw Ar}throw _r},Yn=e=>{let t=e.arr[e.pos++],n=t&An,s=64;const r=(t&st)>0?-1:1;if(!(t&N))return r*n;const i=e.arr.length;for(;e.pos<i;){if(t=e.arr[e.pos++],n=n+(t&pt)*s,s*=128,t<N)return r*n;if(n>Cr)throw Ar}throw _r},Ac=e=>{let t=w(e);if(t===0)return"";{let n=String.fromCodePoint(Ot(e));if(--t<100)for(;t--;)n+=String.fromCodePoint(Ot(e));else for(;t>0;){const s=t<1e4?t:1e4,r=e.arr.subarray(e.pos,e.pos+s);e.pos+=s,n+=String.fromCodePoint.apply(null,r),t-=s}return decodeURIComponent(escape(n))}},Dc=e=>Ht.decode(R(e)),Tt=Ht?Dc:Ac,Gn=(e,t)=>{const n=new DataView(e.arr.buffer,e.arr.byteOffset+e.pos,t);return e.pos+=t,n},Ec=e=>Gn(e,4).getFloat32(0,!1),Tc=e=>Gn(e,8).getFloat64(0,!1),Ic=e=>Gn(e,8).getBigInt64(0,!1),Uc=[e=>{},e=>null,Yn,Ec,Tc,Ic,e=>!1,e=>!0,Tt,e=>{const t=w(e),n={};for(let s=0;s<t;s++){const r=Tt(e);n[r]=Qt(e)}return n},e=>{const t=w(e),n=[];for(let s=0;s<t;s++)n.push(Qt(e));return n},R],Qt=e=>Uc[127-Ot(e)](e);class Ms extends Ke{constructor(t,n){super(t),this.reader=n,this.s=null,this.count=0}read(){return this.count===0&&(this.s=this.reader(this),Cc(this)?this.count=w(this)+1:this.count=-1),this.count--,this.s}}class Ie extends Ke{constructor(t){super(t),this.s=0,this.count=0}read(){if(this.count===0){this.s=Yn(this);const t=br(this.s);this.count=1,t&&(this.s=-this.s,this.count=w(this)+2)}return this.count--,this.s}}class hn extends Ke{constructor(t){super(t),this.s=0,this.count=0,this.diff=0}read(){if(this.count===0){const t=Yn(this),n=t&1;this.diff=rt(t/2),this.count=1,n&&(this.count=w(this)+2)}return this.s+=this.diff,this.count--,this.s}}class vc{constructor(t){this.decoder=new Ie(t),this.str=Tt(this.decoder),this.spos=0}read(){const t=this.spos+this.decoder.read(),n=this.str.slice(this.spos,t);return this.spos=t,n}}const Mc=e=>new Uint8Array(e),Wn=(e,t,n)=>new Uint8Array(e,t,n),xc=e=>{const t=Mc(e.byteLength);return t.set(e),t};let ge=class{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}};const Xe=()=>new ge,Oc=e=>{let t=e.cpos;for(let n=0;n<e.bufs.length;n++)t+=e.bufs[n].length;return t},X=e=>{const t=new Uint8Array(Oc(e));let n=0;for(let s=0;s<e.bufs.length;s++){const r=e.bufs[s];t.set(r,n),n+=r.length}return t.set(Wn(e.cbuf.buffer,0,e.cpos),n),t},Lc=(e,t)=>{const n=e.cbuf.length;n-e.cpos<t&&(e.bufs.push(Wn(e.cbuf.buffer,0,e.cpos)),e.cbuf=new Uint8Array(it(n,t)*2),e.cpos=0)},I=(e,t)=>{const n=e.cbuf.length;e.cpos===n&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(n*2),e.cpos=0),e.cbuf[e.cpos++]=t},Dn=I,y=(e,t)=>{for(;t>pt;)I(e,N|pt&t),t=rt(t/128);I(e,pt&t)},Kn=(e,t)=>{const n=br(t);for(n&&(t=-t),I(e,(t>An?N:0)|(n?st:0)|An&t),t=rt(t/64);t>0;)I(e,(t>pt?N:0)|pt&t),t=rt(t/128)},En=new Uint8Array(3e4),Rc=En.length/3,$c=(e,t)=>{if(t.length<Rc){const n=Kt.encodeInto(t,En).written||0;y(e,n);for(let s=0;s<n;s++)I(e,En[s])}else $(e,rc(t))},Nc=(e,t)=>{const n=unescape(encodeURIComponent(t)),s=n.length;y(e,s);for(let r=0;r<s;r++)I(e,n.codePointAt(r))},It=Kt&&Kt.encodeInto?$c:Nc,Qe=(e,t)=>{const n=e.cbuf.length,s=e.cpos,r=gt(n-s,t.length),i=t.length-r;e.cbuf.set(t.subarray(0,r),s),e.cpos+=r,i>0&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(it(n*2,i)),e.cbuf.set(t.subarray(r)),e.cpos=i)},$=(e,t)=>{y(e,t.byteLength),Qe(e,t)},Xn=(e,t)=>{Lc(e,t);const n=new DataView(e.cbuf.buffer,e.cpos,t);return e.cpos+=t,n},Vc=(e,t)=>Xn(e,4).setFloat32(0,t,!1),Bc=(e,t)=>Xn(e,8).setFloat64(0,t,!1),Pc=(e,t)=>Xn(e,8).setBigInt64(0,t,!1),xs=new DataView(new ArrayBuffer(4)),Fc=e=>(xs.setFloat32(0,e),xs.getFloat32(0)===e),Zt=(e,t)=>{switch(typeof t){case"string":I(e,119),It(e,t);break;case"number":kc(t)&&Te(t)<=Sc?(I(e,125),Kn(e,t)):Fc(t)?(I(e,124),Vc(e,t)):(I(e,123),Bc(e,t));break;case"bigint":I(e,122),Pc(e,t);break;case"object":if(t===null)I(e,126);else if(kn(t)){I(e,117),y(e,t.length);for(let n=0;n<t.length;n++)Zt(e,t[n])}else if(t instanceof Uint8Array)I(e,116),$(e,t);else{I(e,118);const n=Object.keys(t);y(e,n.length);for(let s=0;s<n.length;s++){const r=n[s];It(e,r),Zt(e,t[r])}}break;case"boolean":I(e,t?120:121);break;default:I(e,127)}};class Os extends ge{constructor(t){super(),this.w=t,this.s=null,this.count=0}write(t){this.s===t?this.count++:(this.count>0&&y(this,this.count-1),this.count=1,this.w(this,t),this.s=t)}}const Ls=e=>{e.count>0&&(Kn(e.encoder,e.count===1?e.s:-e.s),e.count>1&&y(e.encoder,e.count-2))};class Ue{constructor(){this.encoder=new ge,this.s=0,this.count=0}write(t){this.s===t?this.count++:(Ls(this),this.count=1,this.s=t)}toUint8Array(){return Ls(this),X(this.encoder)}}const Rs=e=>{if(e.count>0){const t=e.diff*2+(e.count===1?0:1);Kn(e.encoder,t),e.count>1&&y(e.encoder,e.count-2)}};class un{constructor(){this.encoder=new ge,this.s=0,this.count=0,this.diff=0}write(t){this.diff===t-this.s?(this.s=t,this.count++):(Rs(this),this.count=1,this.diff=t-this.s,this.s=t)}toUint8Array(){return Rs(this),X(this.encoder)}}class jc{constructor(){this.sarr=[],this.s="",this.lensE=new Ue}write(t){this.s+=t,this.s.length>19&&(this.sarr.push(this.s),this.s=""),this.lensE.write(t.length)}toUint8Array(){const t=new ge;return this.sarr.push(this.s),this.s="",It(t,this.sarr.join("")),Qe(t,this.lensE.toUint8Array()),X(t)}}const zc=crypto.getRandomValues.bind(crypto),Hc=Math.random,Dr=()=>zc(new Uint32Array(1))[0],Jc=e=>e[rt(Hc()*e.length)],qc=[1e7]+-1e3+-4e3+-8e3+-1e11,Yc=()=>qc.replace(/[018]/g,e=>(e^Dr()&15>>e/4).toString(16)),Gc=Date.now,$s=e=>new Promise(e);Promise.all.bind(Promise);class Wc{constructor(t,n){this.left=t,this.right=n}}const nt=(e,t)=>new Wc(e,t),ft=typeof document<"u"?document:{};typeof DOMParser<"u"&&new DOMParser;const Kc=e=>Go(e,(t,n)=>`${n}:${t};`).join("");ft.ELEMENT_NODE;ft.TEXT_NODE;ft.CDATA_SECTION_NODE;ft.COMMENT_NODE;ft.DOCUMENT_NODE;ft.DOCUMENT_TYPE_NODE;ft.DOCUMENT_FRAGMENT_NODE;const Xc=e=>class{constructor(n){this._=n}destroy(){e(this._)}},Qc=Xc(clearTimeout),$e=(e,t)=>new Qc(setTimeout(t,e)),lt=Symbol,Er=lt(),Tr=lt(),Zc=lt(),tl=lt(),el=lt(),Ir=lt(),nl=lt(),Ur=lt(),sl=lt(),rl=e=>{const t=[];let n=0;for(;n<e.length;n++){const s=e[n];s.constructor===String||s.constructor===Number||s.constructor===Object&&t.push(JSON.stringify(s))}return t},il={[Er]:nt("font-weight","bold"),[Tr]:nt("font-weight","normal"),[Zc]:nt("color","blue"),[el]:nt("color","green"),[tl]:nt("color","grey"),[Ir]:nt("color","red"),[nl]:nt("color","purple"),[Ur]:nt("color","orange"),[sl]:nt("color","black")},ol=e=>{const t=[],n=[],s=F();let r=[],i=0;for(;i<e.length;i++){const o=e[i],c=il[o];if(c!==void 0)s.set(c.left,c.right);else if(o.constructor===String||o.constructor===Number){const l=Kc(s);i>0||l.length>0?(t.push("%c"+o),n.push(l)):t.push(o)}else break}for(i>0&&(r=n,r.unshift(t.join("")));i<e.length;i++){const o=e[i];o instanceof Symbol||r.push(o)}return r},cl=bc?ol:rl,ll=(...e)=>{console.log(...cl(e)),al.forEach(t=>t.print(e))},al=wt(),vr=e=>({[Symbol.iterator](){return this},next:e}),hl=(e,t)=>vr(()=>{let n;do n=e.next();while(!n.done&&!t(n.value));return n}),dn=(e,t)=>vr(()=>{const{done:n,value:s}=e.next();return{done:n,value:n?void 0:t(s)}});class Qn{constructor(t,n){this.clock=t,this.len=n}}class Bt{constructor(){this.clients=new Map}}const ot=(e,t,n)=>t.clients.forEach((s,r)=>{const i=e.doc.store.clients.get(r);for(let o=0;o<s.length;o++){const c=s[o];zr(e,i,c.clock,c.len,n)}}),ul=(e,t)=>{let n=0,s=e.length-1;for(;n<=s;){const r=rt((n+s)/2),i=e[r],o=i.clock;if(o<=t){if(t<o+i.len)return r;n=r+1}else s=r-1}return null},Pt=(e,t)=>{const n=e.clients.get(t.client);return n!==void 0&&ul(n,t.clock)!==null},Zn=e=>{e.clients.forEach(t=>{t.sort((r,i)=>r.clock-i.clock);let n,s;for(n=1,s=1;n<t.length;n++){const r=t[s-1],i=t[n];r.clock+r.len>=i.clock?r.len=it(r.len,i.clock+i.len-r.clock):(s<n&&(t[s]=i),s++)}t.length=s})},Tn=e=>{const t=new Bt;for(let n=0;n<e.length;n++)e[n].clients.forEach((s,r)=>{if(!t.clients.has(r)){const i=s.slice();for(let o=n+1;o<e.length;o++)Ko(i,e[o].clients.get(r)||[]);t.clients.set(r,i)}});return Zn(t),t},te=(e,t,n,s)=>{ct(e.clients,t,()=>[]).push(new Qn(n,s))},ts=()=>new Bt,Mr=e=>{const t=ts();return e.clients.forEach((n,s)=>{const r=[];for(let i=0;i<n.length;i++){const o=n[i];if(o.deleted){const c=o.id.clock;let l=o.length;if(i+1<n.length)for(let a=n[i+1];i+1<n.length&&a.deleted;a=n[++i+1])l+=a.length;r.push(new Qn(c,l))}}r.length>0&&t.clients.set(s,r)}),t},Ft=(e,t)=>{y(e.restEncoder,t.clients.size),dt(t.clients.entries()).sort((n,s)=>s[0]-n[0]).forEach(([n,s])=>{e.resetDsCurVal(),y(e.restEncoder,n);const r=s.length;y(e.restEncoder,r);for(let i=0;i<r;i++){const o=s[i];e.writeDsClock(o.clock),e.writeDsLen(o.len)}})},es=e=>{const t=new Bt,n=w(e.restDecoder);for(let s=0;s<n;s++){e.resetDsCurVal();const r=w(e.restDecoder),i=w(e.restDecoder);if(i>0){const o=ct(t.clients,r,()=>[]);for(let c=0;c<i;c++)o.push(new Qn(e.readDsClock(),e.readDsLen()))}}return t},Ns=(e,t,n)=>{const s=new Bt,r=w(e.restDecoder);for(let i=0;i<r;i++){e.resetDsCurVal();const o=w(e.restDecoder),c=w(e.restDecoder),l=n.clients.get(o)||[],a=D(n,o);for(let h=0;h<c;h++){const u=e.readDsClock(),d=u+e.readDsLen();if(u<a){a<d&&te(s,o,a,d-a);let f=Q(l,u),g=l[f];for(!g.deleted&&g.id.clock<u&&(l.splice(f+1,0,je(t,g,u-g.id.clock)),f++);f<l.length&&(g=l[f++],g.id.clock<d);)g.deleted||(d<g.id.clock+g.length&&l.splice(f,0,je(t,g,d-g.id.clock)),g.delete(t))}else te(s,o,u,d-u)}}if(s.clients.size>0){const i=new yt;return y(i.restEncoder,0),Ft(i,s),i.toUint8Array()}return null},xr=Dr;class Ct extends yr{constructor({guid:t=Yc(),collectionid:n=null,gc:s=!0,gcFilter:r=()=>!0,meta:i=null,autoLoad:o=!1,shouldLoad:c=!0}={}){super(),this.gc=s,this.gcFilter=r,this.clientID=xr(),this.guid=t,this.collectionid=n,this.share=new Map,this.store=new Fr,this._transaction=null,this._transactionCleanups=[],this.subdocs=new Set,this._item=null,this.shouldLoad=c,this.autoLoad=o,this.meta=i,this.isLoaded=!1,this.isSynced=!1,this.whenLoaded=$s(a=>{this.on("load",()=>{this.isLoaded=!0,a(this)})});const l=()=>$s(a=>{const h=u=>{(u===void 0||u===!0)&&(this.off("sync",h),a())};this.on("sync",h)});this.on("sync",a=>{a===!1&&this.isSynced&&(this.whenSynced=l()),this.isSynced=a===void 0||a===!0,this.isLoaded||this.emit("load",[])}),this.whenSynced=l()}load(){const t=this._item;t!==null&&!this.shouldLoad&&_(t.parent.doc,n=>{n.subdocsLoaded.add(this)},null,!0),this.shouldLoad=!0}getSubdocs(){return this.subdocs}getSubdocGuids(){return new Set(dt(this.subdocs).map(t=>t.guid))}transact(t,n=null){return _(this,t,n)}get(t,n=x){const s=ct(this.share,t,()=>{const i=new n;return i._integrate(this,null),i}),r=s.constructor;if(n!==x&&r!==n)if(r===x){const i=new n;i._map=s._map,s._map.forEach(o=>{for(;o!==null;o=o.left)o.parent=i}),i._start=s._start;for(let o=i._start;o!==null;o=o.right)o.parent=i;return i._length=s._length,this.share.set(t,i),i._integrate(this,null),i}else throw new Error(`Type with the name ${t} has already been defined with a different constructor`);return s}getArray(t=""){return this.get(t,vt)}getText(t=""){return this.get(t,bt)}getMap(t=""){return this.get(t,Rt)}getXmlFragment(t=""){return this.get(t,St)}toJSON(){const t={};return this.share.forEach((n,s)=>{t[s]=n.toJSON()}),t}destroy(){dt(this.subdocs).forEach(n=>n.destroy());const t=this._item;if(t!==null){this._item=null;const n=t.content;n.doc=new Ct({guid:this.guid,...n.opts,shouldLoad:!1}),n.doc._item=t,_(t.parent.doc,s=>{const r=n.doc;t.deleted||s.subdocsAdded.add(r),s.subdocsRemoved.add(this)},null,!0)}this.emit("destroyed",[!0]),this.emit("destroy",[this]),super.destroy()}on(t,n){super.on(t,n)}off(t,n){super.off(t,n)}}class Or{constructor(t){this.restDecoder=t}resetDsCurVal(){}readDsClock(){return w(this.restDecoder)}readDsLen(){return w(this.restDecoder)}}class Lr extends Or{readLeftID(){return m(w(this.restDecoder),w(this.restDecoder))}readRightID(){return m(w(this.restDecoder),w(this.restDecoder))}readClient(){return w(this.restDecoder)}readInfo(){return Ot(this.restDecoder)}readString(){return Tt(this.restDecoder)}readParentInfo(){return w(this.restDecoder)===1}readTypeRef(){return w(this.restDecoder)}readLen(){return w(this.restDecoder)}readAny(){return Qt(this.restDecoder)}readBuf(){return xc(R(this.restDecoder))}readJSON(){return JSON.parse(Tt(this.restDecoder))}readKey(){return Tt(this.restDecoder)}}class dl{constructor(t){this.dsCurrVal=0,this.restDecoder=t}resetDsCurVal(){this.dsCurrVal=0}readDsClock(){return this.dsCurrVal+=w(this.restDecoder),this.dsCurrVal}readDsLen(){const t=w(this.restDecoder)+1;return this.dsCurrVal+=t,t}}class Lt extends dl{constructor(t){super(t),this.keys=[],w(t),this.keyClockDecoder=new hn(R(t)),this.clientDecoder=new Ie(R(t)),this.leftClockDecoder=new hn(R(t)),this.rightClockDecoder=new hn(R(t)),this.infoDecoder=new Ms(R(t),Ot),this.stringDecoder=new vc(R(t)),this.parentInfoDecoder=new Ms(R(t),Ot),this.typeRefDecoder=new Ie(R(t)),this.lenDecoder=new Ie(R(t))}readLeftID(){return new Ut(this.clientDecoder.read(),this.leftClockDecoder.read())}readRightID(){return new Ut(this.clientDecoder.read(),this.rightClockDecoder.read())}readClient(){return this.clientDecoder.read()}readInfo(){return this.infoDecoder.read()}readString(){return this.stringDecoder.read()}readParentInfo(){return this.parentInfoDecoder.read()===1}readTypeRef(){return this.typeRefDecoder.read()}readLen(){return this.lenDecoder.read()}readAny(){return Qt(this.restDecoder)}readBuf(){return R(this.restDecoder)}readJSON(){return Qt(this.restDecoder)}readKey(){const t=this.keyClockDecoder.read();if(t<this.keys.length)return this.keys[t];{const n=this.stringDecoder.read();return this.keys.push(n),n}}}class Rr{constructor(){this.restEncoder=Xe()}toUint8Array(){return X(this.restEncoder)}resetDsCurVal(){}writeDsClock(t){y(this.restEncoder,t)}writeDsLen(t){y(this.restEncoder,t)}}class pe extends Rr{writeLeftID(t){y(this.restEncoder,t.client),y(this.restEncoder,t.clock)}writeRightID(t){y(this.restEncoder,t.client),y(this.restEncoder,t.clock)}writeClient(t){y(this.restEncoder,t)}writeInfo(t){Dn(this.restEncoder,t)}writeString(t){It(this.restEncoder,t)}writeParentInfo(t){y(this.restEncoder,t?1:0)}writeTypeRef(t){y(this.restEncoder,t)}writeLen(t){y(this.restEncoder,t)}writeAny(t){Zt(this.restEncoder,t)}writeBuf(t){$(this.restEncoder,t)}writeJSON(t){It(this.restEncoder,JSON.stringify(t))}writeKey(t){It(this.restEncoder,t)}}class $r{constructor(){this.restEncoder=Xe(),this.dsCurrVal=0}toUint8Array(){return X(this.restEncoder)}resetDsCurVal(){this.dsCurrVal=0}writeDsClock(t){const n=t-this.dsCurrVal;this.dsCurrVal=t,y(this.restEncoder,n)}writeDsLen(t){t===0&&j(),y(this.restEncoder,t-1),this.dsCurrVal+=t}}class yt extends $r{constructor(){super(),this.keyMap=new Map,this.keyClock=0,this.keyClockEncoder=new un,this.clientEncoder=new Ue,this.leftClockEncoder=new un,this.rightClockEncoder=new un,this.infoEncoder=new Os(Dn),this.stringEncoder=new jc,this.parentInfoEncoder=new Os(Dn),this.typeRefEncoder=new Ue,this.lenEncoder=new Ue}toUint8Array(){const t=Xe();return y(t,0),$(t,this.keyClockEncoder.toUint8Array()),$(t,this.clientEncoder.toUint8Array()),$(t,this.leftClockEncoder.toUint8Array()),$(t,this.rightClockEncoder.toUint8Array()),$(t,X(this.infoEncoder)),$(t,this.stringEncoder.toUint8Array()),$(t,X(this.parentInfoEncoder)),$(t,this.typeRefEncoder.toUint8Array()),$(t,this.lenEncoder.toUint8Array()),Qe(t,X(this.restEncoder)),X(t)}writeLeftID(t){this.clientEncoder.write(t.client),this.leftClockEncoder.write(t.clock)}writeRightID(t){this.clientEncoder.write(t.client),this.rightClockEncoder.write(t.clock)}writeClient(t){this.clientEncoder.write(t)}writeInfo(t){this.infoEncoder.write(t)}writeString(t){this.stringEncoder.write(t)}writeParentInfo(t){this.parentInfoEncoder.write(t?1:0)}writeTypeRef(t){this.typeRefEncoder.write(t)}writeLen(t){this.lenEncoder.write(t)}writeAny(t){Zt(this.restEncoder,t)}writeBuf(t){$(this.restEncoder,t)}writeJSON(t){Zt(this.restEncoder,t)}writeKey(t){const n=this.keyMap.get(t);n===void 0?(this.keyClockEncoder.write(this.keyClock++),this.stringEncoder.write(t)):this.keyClockEncoder.write(n)}}const fl=(e,t,n,s)=>{s=it(s,t[0].id.clock);const r=Q(t,s);y(e.restEncoder,t.length-r),e.writeClient(n),y(e.restEncoder,s);const i=t[r];i.write(e,s-i.id.clock);for(let o=r+1;o<t.length;o++)t[o].write(e,0)},ns=(e,t,n)=>{const s=new Map;n.forEach((r,i)=>{D(t,i)>r&&s.set(i,r)}),me(t).forEach((r,i)=>{n.has(i)||s.set(i,0)}),y(e.restEncoder,s.size),dt(s.entries()).sort((r,i)=>i[0]-r[0]).forEach(([r,i])=>{fl(e,t.clients.get(r),r,i)})},gl=(e,t)=>{const n=F(),s=w(e.restDecoder);for(let r=0;r<s;r++){const i=w(e.restDecoder),o=new Array(i),c=e.readClient();let l=w(e.restDecoder);n.set(c,{i:0,refs:o});for(let a=0;a<i;a++){const h=e.readInfo();switch(We&h){case 0:{const u=e.readLen();o[a]=new B(m(c,l),u),l+=u;break}case 10:{const u=w(e.restDecoder);o[a]=new P(m(c,l),u),l+=u;break}default:{const u=(h&(st|N))===0,d=new k(m(c,l),null,(h&N)===N?e.readLeftID():null,null,(h&st)===st?e.readRightID():null,u?e.readParentInfo()?t.get(e.readString()):e.readLeftID():null,u&&(h&Xt)===Xt?e.readString():null,hi(e,h));o[a]=d,l+=d.length}}}}return n},pl=(e,t,n)=>{const s=[];let r=dt(n.keys()).sort((f,g)=>f-g);if(r.length===0)return null;const i=()=>{if(r.length===0)return null;let f=n.get(r[r.length-1]);for(;f.refs.length===f.i;)if(r.pop(),r.length>0)f=n.get(r[r.length-1]);else return null;return f};let o=i();if(o===null&&s.length===0)return null;const c=new Fr,l=new Map,a=(f,g)=>{const p=l.get(f);(p==null||p>g)&&l.set(f,g)};let h=o.refs[o.i++];const u=new Map,d=()=>{for(const f of s){const g=f.id.client,p=n.get(g);p?(p.i--,c.clients.set(g,p.refs.slice(p.i)),n.delete(g),p.i=0,p.refs=[]):c.clients.set(g,[f]),r=r.filter(b=>b!==g)}s.length=0};for(;;){if(h.constructor!==P){const g=ct(u,h.id.client,()=>D(t,h.id.client))-h.id.clock;if(g<0)s.push(h),a(h.id.client,h.id.clock-1),d();else{const p=h.getMissing(e,t);if(p!==null){s.push(h);const b=n.get(p)||{refs:[],i:0};if(b.refs.length===b.i)a(p,D(t,p)),d();else{h=b.refs[b.i++];continue}}else(g===0||g<h.length)&&(h.integrate(e,g),u.set(h.id.client,h.id.clock+h.length))}}if(s.length>0)h=s.pop();else if(o!==null&&o.i<o.refs.length)h=o.refs[o.i++];else{if(o=i(),o===null)break;h=o.refs[o.i++]}}if(c.clients.size>0){const f=new yt;return ns(f,c,new Map),y(f.restEncoder,0),{missing:l,update:f.toUint8Array()}}return null},ml=(e,t)=>ns(e,t.doc.store,t.beforeState),wl=(e,t,n,s=new Lt(e))=>_(t,r=>{r.local=!1;let i=!1;const o=r.doc,c=o.store,l=gl(s,o),a=pl(r,c,l),h=c.pendingStructs;if(h){for(const[d,f]of h.missing)if(f<D(c,d)){i=!0;break}if(a){for(const[d,f]of a.missing){const g=h.missing.get(d);(g==null||g>f)&&h.missing.set(d,f)}h.update=Ne([h.update,a.update])}}else c.pendingStructs=a;const u=Ns(s,r,c);if(c.pendingDs){const d=new Lt(Vt(c.pendingDs));w(d.restDecoder);const f=Ns(d,r,c);u&&f?c.pendingDs=Ne([u,f]):c.pendingDs=u||f}else c.pendingDs=u;if(i){const d=c.pendingStructs.update;c.pendingStructs=null,Nr(r.doc,d)}},n,!1),Nr=(e,t,n,s=Lt)=>{const r=Vt(t);wl(r,e,n,new s(r))},yl=(e,t,n)=>Nr(e,t,n,Lr),bl=(e,t,n=new Map)=>{ns(e,t.store,n),Ft(e,Mr(t.store))},Sl=(e,t=new Uint8Array([0]),n=new yt)=>{const s=Vr(t);bl(n,e,s);const r=[n.toUint8Array()];if(e.store.pendingDs&&r.push(e.store.pendingDs),e.store.pendingStructs&&r.push(Fl(e.store.pendingStructs.update,t)),r.length>1){if(n.constructor===pe)return Bl(r.map((i,o)=>o===0?i:zl(i)));if(n.constructor===yt)return Ne(r)}return r[0]},kl=(e,t)=>Sl(e,t,new pe),Cl=e=>{const t=new Map,n=w(e.restDecoder);for(let s=0;s<n;s++){const r=w(e.restDecoder),i=w(e.restDecoder);t.set(r,i)}return t},Vr=e=>Cl(new Or(Vt(e))),Br=(e,t)=>(y(e.restEncoder,t.size),dt(t.entries()).sort((n,s)=>s[0]-n[0]).forEach(([n,s])=>{y(e.restEncoder,n),y(e.restEncoder,s)}),e),_l=(e,t)=>Br(e,me(t.store)),Al=(e,t=new $r)=>(e instanceof Map?Br(t,e):_l(t,e),t.toUint8Array()),Dl=e=>Al(e,new Rr);class El{constructor(){this.l=[]}}const Vs=()=>new El,Bs=(e,t)=>e.l.push(t),Ps=(e,t)=>{const n=e.l,s=n.length;e.l=n.filter(r=>t!==r),s===e.l.length&&console.error("[yjs] Tried to remove event handler that doesn't exist.")},Pr=(e,t,n)=>qn(e.l,[t,n]);class Ut{constructor(t,n){this.client=t,this.clock=n}}const Et=(e,t)=>e===t||e!==null&&t!==null&&e.client===t.client&&e.clock===t.clock,m=(e,t)=>new Ut(e,t),ee=e=>{for(const[t,n]of e.doc.share.entries())if(n===e)return t;throw j()},ne=(e,t)=>{for(;t!==null;){if(t.parent===e)return!0;t=t.parent._item}return!1};class se{constructor(t,n,s,r=0){this.type=t,this.tname=n,this.item=s,this.assoc=r}}const Jt=e=>new se(e.type==null?null:m(e.type.client,e.type.clock),e.tname||null,e.item==null?null:m(e.item.client,e.item.clock),e.assoc==null?0:e.assoc);class Tl{constructor(t,n,s=0){this.type=t,this.index=n,this.assoc=s}}const Il=(e,t,n=0)=>new Tl(e,t,n),Ce=(e,t,n)=>{let s=null,r=null;return e._item===null?r=ee(e):s=m(e._item.id.client,e._item.id.clock),new se(s,r,t,n)},fn=(e,t,n=0)=>{let s=e._start;if(n<0){if(t===0)return Ce(e,null,n);t--}for(;s!==null;){if(!s.deleted&&s.countable){if(s.length>t)return Ce(e,m(s.id.client,s.id.clock+t),n);t-=s.length}if(s.right===null&&n<0)return Ce(e,s.lastId,n);s=s.right}return Ce(e,null,n)},Ul=(e,t)=>{const n=t.store,s=e.item,r=e.type,i=e.tname,o=e.assoc;let c=null,l=0;if(s!==null){if(D(n,s.client)<=s.clock)return null;const a=Mn(n,s),h=a.item;if(!(h instanceof k))return null;if(c=h.parent,c._item===null||!c._item.deleted){l=h.deleted||!h.countable?0:a.diff+(o>=0?0:1);let u=h.left;for(;u!==null;)!u.deleted&&u.countable&&(l+=u.length),u=u.left}}else{if(i!==null)c=t.get(i);else if(r!==null){if(D(n,r.client)<=r.clock)return null;const{item:a}=Mn(n,r);if(a instanceof k&&a.content instanceof Y)c=a.content.type;else return null}else throw j();o>=0?l=c._length:l=0}return Il(c,l,e.assoc)},Fs=(e,t)=>e===t||e!==null&&t!==null&&e.tname===t.tname&&Et(e.item,t.item)&&Et(e.type,t.type)&&e.assoc===t.assoc;class ss{constructor(t,n){this.ds=t,this.sv=n}}const rs=(e,t)=>new ss(e,t);rs(ts(),new Map);const vl=e=>rs(Mr(e.store),me(e.store)),Dt=(e,t)=>t===void 0?!e.deleted:t.sv.has(e.id.client)&&(t.sv.get(e.id.client)||0)>e.id.clock&&!Pt(t.ds,e.id),In=(e,t)=>{const n=ct(e.meta,In,wt),s=e.doc.store;n.has(t)||(t.sv.forEach((r,i)=>{r<D(s,i)&&O(e,m(i,r))}),ot(e,t.ds,r=>{}),n.add(t))};class Fr{constructor(){this.clients=new Map,this.pendingStructs=null,this.pendingDs=null}}const me=e=>{const t=new Map;return e.clients.forEach((n,s)=>{const r=n[n.length-1];t.set(s,r.id.clock+r.length)}),t},D=(e,t)=>{const n=e.clients.get(t);if(n===void 0)return 0;const s=n[n.length-1];return s.id.clock+s.length},jr=(e,t)=>{let n=e.clients.get(t.id.client);if(n===void 0)n=[],e.clients.set(t.id.client,n);else{const s=n[n.length-1];if(s.id.clock+s.length!==t.id.clock)throw j()}n.push(t)},Q=(e,t)=>{let n=0,s=e.length-1,r=e[s],i=r.id.clock;if(i===t)return s;let o=rt(t/(i+r.length-1)*s);for(;n<=s;){if(r=e[o],i=r.id.clock,i<=t){if(t<i+r.length)return o;n=o+1}else s=o-1;o=rt((n+s)/2)}throw j()},Ml=(e,t)=>{const n=e.clients.get(t.client);return n[Q(n,t.clock)]},ve=Ml,Un=(e,t,n)=>{const s=Q(t,n),r=t[s];return r.id.clock<n&&r instanceof k?(t.splice(s+1,0,je(e,r,n-r.id.clock)),s+1):s},O=(e,t)=>{const n=e.doc.store.clients.get(t.client);return n[Un(e,n,t.clock)]},js=(e,t,n)=>{const s=t.clients.get(n.client),r=Q(s,n.clock),i=s[r];return n.clock!==i.id.clock+i.length-1&&i.constructor!==B&&s.splice(r+1,0,je(e,i,n.clock-i.id.clock+1)),i},xl=(e,t,n)=>{const s=e.clients.get(t.id.client);s[Q(s,t.id.clock)]=n},zr=(e,t,n,s,r)=>{if(s===0)return;const i=n+s;let o=Un(e,t,n),c;do c=t[o++],i<c.id.clock+c.length&&Un(e,t,i),r(c);while(o<t.length&&t[o].id.clock<i)};class Ol{constructor(t,n,s){this.doc=t,this.deleteSet=new Bt,this.beforeState=me(t.store),this.afterState=new Map,this.changed=new Map,this.changedParentTypes=new Map,this._mergeStructs=[],this.origin=n,this.meta=new Map,this.local=s,this.subdocsAdded=new Set,this.subdocsRemoved=new Set,this.subdocsLoaded=new Set}}const zs=(e,t)=>t.deleteSet.clients.size===0&&!Wo(t.afterState,(n,s)=>t.beforeState.get(s)!==n)?!1:(Zn(t.deleteSet),ml(e,t),Ft(e,t.deleteSet),!0),Hs=(e,t,n)=>{const s=t._item;(s===null||s.id.clock<(e.beforeState.get(s.id.client)||0)&&!s.deleted)&&ct(e.changed,t,wt).add(n)},Me=(e,t)=>{const n=e[t-1],s=e[t];n.deleted===s.deleted&&n.constructor===s.constructor&&n.mergeWith(s)&&(e.splice(t,1),s instanceof k&&s.parentSub!==null&&s.parent._map.get(s.parentSub)===s&&s.parent._map.set(s.parentSub,n))},Ll=(e,t,n)=>{for(const[s,r]of e.clients.entries()){const i=t.clients.get(s);for(let o=r.length-1;o>=0;o--){const c=r[o],l=c.clock+c.len;for(let a=Q(i,c.clock),h=i[a];a<i.length&&h.id.clock<l;h=i[++a]){const u=i[a];if(c.clock+c.len<=u.id.clock)break;u instanceof k&&u.deleted&&!u.keep&&n(u)&&u.gc(t,!1)}}}},Rl=(e,t)=>{e.clients.forEach((n,s)=>{const r=t.clients.get(s);for(let i=n.length-1;i>=0;i--){const o=n[i],c=gt(r.length-1,1+Q(r,o.clock+o.len-1));for(let l=c,a=r[l];l>0&&a.id.clock>=o.clock;a=r[--l])Me(r,l)}})},Hr=(e,t)=>{if(t<e.length){const n=e[t],s=n.doc,r=s.store,i=n.deleteSet,o=n._mergeStructs;try{Zn(i),n.afterState=me(n.doc.store),s.emit("beforeObserverCalls",[n,s]);const c=[];n.changed.forEach((l,a)=>c.push(()=>{(a._item===null||!a._item.deleted)&&a._callObserver(n,l)})),c.push(()=>{n.changedParentTypes.forEach((l,a)=>c.push(()=>{(a._item===null||!a._item.deleted)&&(l=l.filter(h=>h.target._item===null||!h.target._item.deleted),l.forEach(h=>{h.currentTarget=a}),l.sort((h,u)=>h.path.length-u.path.length),Pr(a._dEH,l,n))})),c.push(()=>s.emit("afterTransaction",[n,s]))}),qn(c,[])}finally{s.gc&&Ll(i,r,s.gcFilter),Rl(i,r),n.afterState.forEach((h,u)=>{const d=n.beforeState.get(u)||0;if(d!==h){const f=r.clients.get(u),g=it(Q(f,d),1);for(let p=f.length-1;p>=g;p--)Me(f,p)}});for(let h=0;h<o.length;h++){const{client:u,clock:d}=o[h].id,f=r.clients.get(u),g=Q(f,d);g+1<f.length&&Me(f,g+1),g>0&&Me(f,g)}if(!n.local&&n.afterState.get(s.clientID)!==n.beforeState.get(s.clientID)&&(ll(Ur,Er,"[yjs] ",Tr,Ir,"Changed the client-id because another client seems to be using it."),s.clientID=xr()),s.emit("afterTransactionCleanup",[n,s]),s._observers.has("update")){const h=new pe;zs(h,n)&&s.emit("update",[h.toUint8Array(),n.origin,s,n])}if(s._observers.has("updateV2")){const h=new yt;zs(h,n)&&s.emit("updateV2",[h.toUint8Array(),n.origin,s,n])}const{subdocsAdded:c,subdocsLoaded:l,subdocsRemoved:a}=n;(c.size>0||a.size>0||l.size>0)&&(c.forEach(h=>{h.clientID=s.clientID,h.collectionid==null&&(h.collectionid=s.collectionid),s.subdocs.add(h)}),a.forEach(h=>s.subdocs.delete(h)),s.emit("subdocs",[{loaded:l,added:c,removed:a},s,n]),a.forEach(h=>h.destroy())),e.length<=t+1?(s._transactionCleanups=[],s.emit("afterAllTransactions",[s,e])):Hr(e,t+1)}}},_=(e,t,n=null,s=!0)=>{const r=e._transactionCleanups;let i=!1,o=null;e._transaction===null&&(i=!0,e._transaction=new Ol(e,n,s),r.push(e._transaction),r.length===1&&e.emit("beforeAllTransactions",[e]),e.emit("beforeTransaction",[e._transaction,e]));try{o=t(e._transaction)}finally{if(i){const c=e._transaction===r[0];e._transaction=null,c&&Hr(r,0)}}return o};class $l{constructor(t,n){this.insertions=n,this.deletions=t,this.meta=new Map}}const Js=(e,t,n)=>{ot(e,n.deletions,s=>{s instanceof k&&t.scope.some(r=>ne(r,s))&&ds(s,!1)})},qs=(e,t,n)=>{let s=null,r=null;const i=e.doc,o=e.scope;if(_(i,c=>{for(;t.length>0&&s===null;){const l=i.store,a=t.pop(),h=new Set,u=[];let d=!1;ot(c,a.insertions,f=>{if(f instanceof k){if(f.redone!==null){let{item:g,diff:p}=Mn(l,f.id);p>0&&(g=O(c,m(g.id.client,g.id.clock+p))),f=g}!f.deleted&&o.some(g=>ne(g,f))&&u.push(f)}}),ot(c,a.deletions,f=>{f instanceof k&&o.some(g=>ne(g,f))&&!Pt(a.insertions,f.id)&&h.add(f)}),h.forEach(f=>{d=ai(c,f,h,a.insertions,e.ignoreRemoteMapChanges,e)!==null||d});for(let f=u.length-1;f>=0;f--){const g=u[f];e.deleteFilter(g)&&(g.delete(c),d=!0)}s=d?a:null}c.changed.forEach((l,a)=>{l.has(null)&&a._searchMarker&&(a._searchMarker.length=0)}),r=c},e),s!=null){const c=r.changedParentTypes;e.emit("stack-item-popped",[{stackItem:s,type:n,changedParentTypes:c},e])}return s};class Nl extends yr{constructor(t,{captureTimeout:n=500,captureTransaction:s=l=>!0,deleteFilter:r=()=>!0,trackedOrigins:i=new Set([null]),ignoreRemoteMapChanges:o=!1,doc:c=kn(t)?t[0].doc:t.doc}={}){super(),this.scope=[],this.addToScope(t),this.deleteFilter=r,i.add(this),this.trackedOrigins=i,this.captureTransaction=s,this.undoStack=[],this.redoStack=[],this.undoing=!1,this.redoing=!1,this.doc=c,this.lastChange=0,this.ignoreRemoteMapChanges=o,this.captureTimeout=n,this.afterTransactionHandler=l=>{if(!this.captureTransaction(l)||!this.scope.some(b=>l.changedParentTypes.has(b))||!this.trackedOrigins.has(l.origin)&&(!l.origin||!this.trackedOrigins.has(l.origin.constructor)))return;const a=this.undoing,h=this.redoing,u=a?this.redoStack:this.undoStack;a?this.stopCapturing():h||this.clear(!1,!0);const d=new Bt;l.afterState.forEach((b,S)=>{const tt=l.beforeState.get(S)||0,et=b-tt;et>0&&te(d,S,tt,et)});const f=Gc();let g=!1;if(this.lastChange>0&&f-this.lastChange<this.captureTimeout&&u.length>0&&!a&&!h){const b=u[u.length-1];b.deletions=Tn([b.deletions,l.deleteSet]),b.insertions=Tn([b.insertions,d])}else u.push(new $l(l.deleteSet,d)),g=!0;!a&&!h&&(this.lastChange=f),ot(l,l.deleteSet,b=>{b instanceof k&&this.scope.some(S=>ne(S,b))&&ds(b,!0)});const p=[{stackItem:u[u.length-1],origin:l.origin,type:a?"redo":"undo",changedParentTypes:l.changedParentTypes},this];g?this.emit("stack-item-added",p):this.emit("stack-item-updated",p)},this.doc.on("afterTransaction",this.afterTransactionHandler),this.doc.on("destroy",()=>{this.destroy()})}addToScope(t){t=kn(t)?t:[t],t.forEach(n=>{this.scope.every(s=>s!==n)&&this.scope.push(n)})}addTrackedOrigin(t){this.trackedOrigins.add(t)}removeTrackedOrigin(t){this.trackedOrigins.delete(t)}clear(t=!0,n=!0){(t&&this.canUndo()||n&&this.canRedo())&&this.doc.transact(s=>{t&&(this.undoStack.forEach(r=>Js(s,this,r)),this.undoStack=[]),n&&(this.redoStack.forEach(r=>Js(s,this,r)),this.redoStack=[]),this.emit("stack-cleared",[{undoStackCleared:t,redoStackCleared:n}])})}stopCapturing(){this.lastChange=0}undo(){this.undoing=!0;let t;try{t=qs(this,this.undoStack,"undo")}finally{this.undoing=!1}return t}redo(){this.redoing=!0;let t;try{t=qs(this,this.redoStack,"redo")}finally{this.redoing=!1}return t}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}destroy(){this.trackedOrigins.delete(this),this.doc.off("afterTransaction",this.afterTransactionHandler),super.destroy()}}function*Vl(e){const t=w(e.restDecoder);for(let n=0;n<t;n++){const s=w(e.restDecoder),r=e.readClient();let i=w(e.restDecoder);for(let o=0;o<s;o++){const c=e.readInfo();if(c===10){const l=w(e.restDecoder);yield new P(m(r,i),l),i+=l}else if(We&c){const l=(c&(st|N))===0,a=new k(m(r,i),null,(c&N)===N?e.readLeftID():null,null,(c&st)===st?e.readRightID():null,l?e.readParentInfo()?e.readString():e.readLeftID():null,l&&(c&Xt)===Xt?e.readString():null,hi(e,c));yield a,i+=a.length}else{const l=e.readLen();yield new B(m(r,i),l),i+=l}}}}class is{constructor(t,n){this.gen=Vl(t),this.curr=null,this.done=!1,this.filterSkips=n,this.next()}next(){do this.curr=this.gen.next().value||null;while(this.filterSkips&&this.curr!==null&&this.curr.constructor===P);return this.curr}}class os{constructor(t){this.currClient=0,this.startClock=0,this.written=0,this.encoder=t,this.clientStructs=[]}}const Bl=e=>Ne(e,Lr,pe),Pl=(e,t)=>{if(e.constructor===B){const{client:n,clock:s}=e.id;return new B(m(n,s+t),e.length-t)}else if(e.constructor===P){const{client:n,clock:s}=e.id;return new P(m(n,s+t),e.length-t)}else{const n=e,{client:s,clock:r}=n.id;return new k(m(s,r+t),null,m(s,r+t-1),null,n.rightOrigin,n.parent,n.parentSub,n.content.splice(t))}},Ne=(e,t=Lt,n=yt)=>{if(e.length===1)return e[0];const s=e.map(h=>new t(Vt(h)));let r=s.map(h=>new is(h,!0)),i=null;const o=new n,c=new os(o);for(;r=r.filter(d=>d.curr!==null),r.sort((d,f)=>{if(d.curr.id.client===f.curr.id.client){const g=d.curr.id.clock-f.curr.id.clock;return g===0?d.curr.constructor===f.curr.constructor?0:d.curr.constructor===P?1:-1:g}else return f.curr.id.client-d.curr.id.client}),r.length!==0;){const h=r[0],u=h.curr.id.client;if(i!==null){let d=h.curr,f=!1;for(;d!==null&&d.id.clock+d.length<=i.struct.id.clock+i.struct.length&&d.id.client>=i.struct.id.client;)d=h.next(),f=!0;if(d===null||d.id.client!==u||f&&d.id.clock>i.struct.id.clock+i.struct.length)continue;if(u!==i.struct.id.client)at(c,i.struct,i.offset),i={struct:d,offset:0},h.next();else if(i.struct.id.clock+i.struct.length<d.id.clock)if(i.struct.constructor===P)i.struct.length=d.id.clock+d.length-i.struct.id.clock;else{at(c,i.struct,i.offset);const g=d.id.clock-i.struct.id.clock-i.struct.length;i={struct:new P(m(u,i.struct.id.clock+i.struct.length),g),offset:0}}else{const g=i.struct.id.clock+i.struct.length-d.id.clock;g>0&&(i.struct.constructor===P?i.struct.length-=g:d=Pl(d,g)),i.struct.mergeWith(d)||(at(c,i.struct,i.offset),i={struct:d,offset:0},h.next())}}else i={struct:h.curr,offset:0},h.next();for(let d=h.curr;d!==null&&d.id.client===u&&d.id.clock===i.struct.id.clock+i.struct.length&&d.constructor!==P;d=h.next())at(c,i.struct,i.offset),i={struct:d,offset:0}}i!==null&&(at(c,i.struct,i.offset),i=null),cs(c);const l=s.map(h=>es(h)),a=Tn(l);return Ft(o,a),o.toUint8Array()},Fl=(e,t,n=Lt,s=yt)=>{const r=Vr(t),i=new s,o=new os(i),c=new n(Vt(e)),l=new is(c,!1);for(;l.curr;){const h=l.curr,u=h.id.client,d=r.get(u)||0;if(l.curr.constructor===P){l.next();continue}if(h.id.clock+h.length>d)for(at(o,h,it(d-h.id.clock,0)),l.next();l.curr&&l.curr.id.client===u;)at(o,l.curr,0),l.next();else for(;l.curr&&l.curr.id.client===u&&l.curr.id.clock+l.curr.length<=d;)l.next()}cs(o);const a=es(c);return Ft(i,a),i.toUint8Array()},Jr=e=>{e.written>0&&(e.clientStructs.push({written:e.written,restEncoder:X(e.encoder.restEncoder)}),e.encoder.restEncoder=Xe(),e.written=0)},at=(e,t,n)=>{e.written>0&&e.currClient!==t.id.client&&Jr(e),e.written===0&&(e.currClient=t.id.client,e.encoder.writeClient(t.id.client),y(e.encoder.restEncoder,t.id.clock+n)),t.write(e.encoder,n),e.written++},cs=e=>{Jr(e);const t=e.encoder.restEncoder;y(t,e.clientStructs.length);for(let n=0;n<e.clientStructs.length;n++){const s=e.clientStructs[n];y(t,s.written),Qe(t,s.restEncoder)}},jl=(e,t,n,s)=>{const r=new n(Vt(e)),i=new is(r,!1),o=new s,c=new os(o);for(let a=i.curr;a!==null;a=i.next())at(c,t(a),0);cs(c);const l=es(r);return Ft(o,l),o.toUint8Array()},zl=e=>jl(e,gc,Lt,pe);class Ze{constructor(t,n){this.target=t,this.currentTarget=t,this.transaction=n,this._changes=null,this._keys=null,this._delta=null}get path(){return Hl(this.currentTarget,this.target)}deletes(t){return Pt(this.transaction.deleteSet,t.id)}get keys(){if(this._keys===null){const t=new Map,n=this.target;this.transaction.changed.get(n).forEach(r=>{if(r!==null){const i=n._map.get(r);let o,c;if(this.adds(i)){let l=i.left;for(;l!==null&&this.adds(l);)l=l.left;if(this.deletes(i))if(l!==null&&this.deletes(l))o="delete",c=cn(l.content.getContent());else return;else l!==null&&this.deletes(l)?(o="update",c=cn(l.content.getContent())):(o="add",c=void 0)}else if(this.deletes(i))o="delete",c=cn(i.content.getContent());else return;t.set(r,{action:o,oldValue:c})}}),this._keys=t}return this._keys}get delta(){return this.changes.delta}adds(t){return t.id.clock>=(this.transaction.beforeState.get(t.id.client)||0)}get changes(){let t=this._changes;if(t===null){const n=this.target,s=wt(),r=wt(),i=[];if(t={added:s,deleted:r,delta:i,keys:this.keys},this.transaction.changed.get(n).has(null)){let c=null;const l=()=>{c&&i.push(c)};for(let a=n._start;a!==null;a=a.right)a.deleted?this.deletes(a)&&!this.adds(a)&&((c===null||c.delete===void 0)&&(l(),c={delete:0}),c.delete+=a.length,r.add(a)):this.adds(a)?((c===null||c.insert===void 0)&&(l(),c={insert:[]}),c.insert=c.insert.concat(a.content.getContent()),s.add(a)):((c===null||c.retain===void 0)&&(l(),c={retain:0}),c.retain+=a.length);c!==null&&c.retain===void 0&&l()}this._changes=t}return t}}const Hl=(e,t)=>{const n=[];for(;t._item!==null&&t!==e;){if(t._item.parentSub!==null)n.unshift(t._item.parentSub);else{let s=0,r=t._item.parent._start;for(;r!==t._item&&r!==null;)r.deleted||s++,r=r.right;n.unshift(s)}t=t._item.parent}return n},qr=80;let ls=0;class Jl{constructor(t,n){t.marker=!0,this.p=t,this.index=n,this.timestamp=ls++}}const ql=e=>{e.timestamp=ls++},Yr=(e,t,n)=>{e.p.marker=!1,e.p=t,t.marker=!0,e.index=n,e.timestamp=ls++},Yl=(e,t,n)=>{if(e.length>=qr){const s=e.reduce((r,i)=>r.timestamp<i.timestamp?r:i);return Yr(s,t,n),s}else{const s=new Jl(t,n);return e.push(s),s}},tn=(e,t)=>{if(e._start===null||t===0||e._searchMarker===null)return null;const n=e._searchMarker.length===0?null:e._searchMarker.reduce((i,o)=>Te(t-i.index)<Te(t-o.index)?i:o);let s=e._start,r=0;for(n!==null&&(s=n.p,r=n.index,ql(n));s.right!==null&&r<t;){if(!s.deleted&&s.countable){if(t<r+s.length)break;r+=s.length}s=s.right}for(;s.left!==null&&r>t;)s=s.left,!s.deleted&&s.countable&&(r-=s.length);for(;s.left!==null&&s.left.id.client===s.id.client&&s.left.id.clock+s.left.length===s.id.clock;)s=s.left,!s.deleted&&s.countable&&(r-=s.length);return n!==null&&Te(n.index-r)<s.parent.length/qr?(Yr(n,s,r),n):Yl(e._searchMarker,s,r)},re=(e,t,n)=>{for(let s=e.length-1;s>=0;s--){const r=e[s];if(n>0){let i=r.p;for(i.marker=!1;i&&(i.deleted||!i.countable);)i=i.left,i&&!i.deleted&&i.countable&&(r.index-=i.length);if(i===null||i.marker===!0){e.splice(s,1);continue}r.p=i,i.marker=!0}(t<r.index||n>0&&t===r.index)&&(r.index=it(t,r.index+n))}},en=(e,t,n)=>{const s=e,r=t.changedParentTypes;for(;ct(r,e,()=>[]).push(n),e._item!==null;)e=e._item.parent;Pr(s._eH,n,t)};class x{constructor(){this._item=null,this._map=new Map,this._start=null,this.doc=null,this._length=0,this._eH=Vs(),this._dEH=Vs(),this._searchMarker=null}get parent(){return this._item?this._item.parent:null}_integrate(t,n){this.doc=t,this._item=n}_copy(){throw H()}clone(){throw H()}_write(t){}get _first(){let t=this._start;for(;t!==null&&t.deleted;)t=t.right;return t}_callObserver(t,n){!t.local&&this._searchMarker&&(this._searchMarker.length=0)}observe(t){Bs(this._eH,t)}observeDeep(t){Bs(this._dEH,t)}unobserve(t){Ps(this._eH,t)}unobserveDeep(t){Ps(this._dEH,t)}toJSON(){}}const Gr=(e,t,n)=>{t<0&&(t=e._length+t),n<0&&(n=e._length+n);let s=n-t;const r=[];let i=e._start;for(;i!==null&&s>0;){if(i.countable&&!i.deleted){const o=i.content.getContent();if(o.length<=t)t-=o.length;else{for(let c=t;c<o.length&&s>0;c++)r.push(o[c]),s--;t=0}}i=i.right}return r},Wr=e=>{const t=[];let n=e._start;for(;n!==null;){if(n.countable&&!n.deleted){const s=n.content.getContent();for(let r=0;r<s.length;r++)t.push(s[r])}n=n.right}return t},Kr=(e,t)=>{const n=[];let s=e._start;for(;s!==null;){if(s.countable&&Dt(s,t)){const r=s.content.getContent();for(let i=0;i<r.length;i++)n.push(r[i])}s=s.right}return n},ie=(e,t)=>{let n=0,s=e._start;for(;s!==null;){if(s.countable&&!s.deleted){const r=s.content.getContent();for(let i=0;i<r.length;i++)t(r[i],n++,e)}s=s.right}},Xr=(e,t)=>{const n=[];return ie(e,(s,r)=>{n.push(t(s,r,e))}),n},Gl=e=>{let t=e._start,n=null,s=0;return{[Symbol.iterator](){return this},next:()=>{if(n===null){for(;t!==null&&t.deleted;)t=t.right;if(t===null)return{done:!0,value:void 0};n=t.content.getContent(),s=0,t=t.right}const r=n[s++];return n.length<=s&&(n=null),{done:!1,value:r}}}},Qr=(e,t)=>{const n=tn(e,t);let s=e._start;for(n!==null&&(s=n.p,t-=n.index);s!==null;s=s.right)if(!s.deleted&&s.countable){if(t<s.length)return s.content.getContent()[t];t-=s.length}},Ve=(e,t,n,s)=>{let r=n;const i=e.doc,o=i.clientID,c=i.store,l=n===null?t._start:n.right;let a=[];const h=()=>{a.length>0&&(r=new k(m(o,D(c,o)),r,r&&r.lastId,l,l&&l.id,t,null,new kt(a)),r.integrate(e,0),a=[])};s.forEach(u=>{if(u===null)a.push(u);else switch(u.constructor){case Number:case Object:case Boolean:case Array:case String:a.push(u);break;default:switch(h(),u.constructor){case Uint8Array:case ArrayBuffer:r=new k(m(o,D(c,o)),r,r&&r.lastId,l,l&&l.id,t,null,new we(new Uint8Array(u))),r.integrate(e,0);break;case Ct:r=new k(m(o,D(c,o)),r,r&&r.lastId,l,l&&l.id,t,null,new ye(u)),r.integrate(e,0);break;default:if(u instanceof x)r=new k(m(o,D(c,o)),r,r&&r.lastId,l,l&&l.id,t,null,new Y(u)),r.integrate(e,0);else throw new Error("Unexpected content type in insert operation")}}}),h()},Zr=Nt("Length exceeded!"),ti=(e,t,n,s)=>{if(n>t._length)throw Zr;if(n===0)return t._searchMarker&&re(t._searchMarker,n,s.length),Ve(e,t,null,s);const r=n,i=tn(t,n);let o=t._start;for(i!==null&&(o=i.p,n-=i.index,n===0&&(o=o.prev,n+=o&&o.countable&&!o.deleted?o.length:0));o!==null;o=o.right)if(!o.deleted&&o.countable){if(n<=o.length){n<o.length&&O(e,m(o.id.client,o.id.clock+n));break}n-=o.length}return t._searchMarker&&re(t._searchMarker,r,s.length),Ve(e,t,o,s)},Wl=(e,t,n)=>{let r=(t._searchMarker||[]).reduce((i,o)=>o.index>i.index?o:i,{index:0,p:t._start}).p;if(r)for(;r.right;)r=r.right;return Ve(e,t,r,n)},ei=(e,t,n,s)=>{if(s===0)return;const r=n,i=s,o=tn(t,n);let c=t._start;for(o!==null&&(c=o.p,n-=o.index);c!==null&&n>0;c=c.right)!c.deleted&&c.countable&&(n<c.length&&O(e,m(c.id.client,c.id.clock+n)),n-=c.length);for(;s>0&&c!==null;)c.deleted||(s<c.length&&O(e,m(c.id.client,c.id.clock+s)),c.delete(e),s-=c.length),c=c.right;if(s>0)throw Zr;t._searchMarker&&re(t._searchMarker,r,-i+s)},Be=(e,t,n)=>{const s=t._map.get(n);s!==void 0&&s.delete(e)},as=(e,t,n,s)=>{const r=t._map.get(n)||null,i=e.doc,o=i.clientID;let c;if(s==null)c=new kt([s]);else switch(s.constructor){case Number:case Object:case Boolean:case Array:case String:c=new kt([s]);break;case Uint8Array:c=new we(s);break;case Ct:c=new ye(s);break;default:if(s instanceof x)c=new Y(s);else throw new Error("Unexpected content type")}new k(m(o,D(i.store,o)),r,r&&r.lastId,null,null,t,n,c).integrate(e,0)},hs=(e,t)=>{const n=e._map.get(t);return n!==void 0&&!n.deleted?n.content.getContent()[n.length-1]:void 0},ni=e=>{const t={};return e._map.forEach((n,s)=>{n.deleted||(t[s]=n.content.getContent()[n.length-1])}),t},si=(e,t)=>{const n=e._map.get(t);return n!==void 0&&!n.deleted},_e=e=>hl(e.entries(),t=>!t[1].deleted);class Kl extends Ze{constructor(t,n){super(t,n),this._transaction=n}}class vt extends x{constructor(){super(),this._prelimContent=[],this._searchMarker=[]}static from(t){const n=new vt;return n.push(t),n}_integrate(t,n){super._integrate(t,n),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new vt}clone(){const t=new vt;return t.insert(0,this.toArray().map(n=>n instanceof x?n.clone():n)),t}get length(){return this._prelimContent===null?this._length:this._prelimContent.length}_callObserver(t,n){super._callObserver(t,n),en(this,t,new Kl(this,t))}insert(t,n){this.doc!==null?_(this.doc,s=>{ti(s,this,t,n)}):this._prelimContent.splice(t,0,...n)}push(t){this.doc!==null?_(this.doc,n=>{Wl(n,this,t)}):this._prelimContent.push(...t)}unshift(t){this.insert(0,t)}delete(t,n=1){this.doc!==null?_(this.doc,s=>{ei(s,this,t,n)}):this._prelimContent.splice(t,n)}get(t){return Qr(this,t)}toArray(){return Wr(this)}slice(t=0,n=this.length){return Gr(this,t,n)}toJSON(){return this.map(t=>t instanceof x?t.toJSON():t)}map(t){return Xr(this,t)}forEach(t){ie(this,t)}[Symbol.iterator](){return Gl(this)}_write(t){t.writeTypeRef(ba)}}const Xl=e=>new vt;class Ql extends Ze{constructor(t,n,s){super(t,n),this.keysChanged=s}}class Rt extends x{constructor(t){super(),this._prelimContent=null,t===void 0?this._prelimContent=new Map:this._prelimContent=new Map(t)}_integrate(t,n){super._integrate(t,n),this._prelimContent.forEach((s,r)=>{this.set(r,s)}),this._prelimContent=null}_copy(){return new Rt}clone(){const t=new Rt;return this.forEach((n,s)=>{t.set(s,n instanceof x?n.clone():n)}),t}_callObserver(t,n){en(this,t,new Ql(this,t,n))}toJSON(){const t={};return this._map.forEach((n,s)=>{if(!n.deleted){const r=n.content.getContent()[n.length-1];t[s]=r instanceof x?r.toJSON():r}}),t}get size(){return[..._e(this._map)].length}keys(){return dn(_e(this._map),t=>t[0])}values(){return dn(_e(this._map),t=>t[1].content.getContent()[t[1].length-1])}entries(){return dn(_e(this._map),t=>[t[0],t[1].content.getContent()[t[1].length-1]])}forEach(t){this._map.forEach((n,s)=>{n.deleted||t(n.content.getContent()[n.length-1],s,this)})}[Symbol.iterator](){return this.entries()}delete(t){this.doc!==null?_(this.doc,n=>{Be(n,this,t)}):this._prelimContent.delete(t)}set(t,n){return this.doc!==null?_(this.doc,s=>{as(s,this,t,n)}):this._prelimContent.set(t,n),n}get(t){return hs(this,t)}has(t){return si(this,t)}clear(){this.doc!==null?_(this.doc,t=>{this.forEach(function(n,s,r){Be(t,r,s)})}):this._prelimContent.clear()}_write(t){t.writeTypeRef(Sa)}}const Zl=e=>new Rt,ht=(e,t)=>e===t||typeof e=="object"&&typeof t=="object"&&e&&t&&fc(e,t);class vn{constructor(t,n,s,r){this.left=t,this.right=n,this.index=s,this.currentAttributes=r}forward(){switch(this.right===null&&j(),this.right.content.constructor){case T:this.right.deleted||jt(this.currentAttributes,this.right.content);break;default:this.right.deleted||(this.index+=this.right.length);break}this.left=this.right,this.right=this.right.right}}const Ys=(e,t,n)=>{for(;t.right!==null&&n>0;){switch(t.right.content.constructor){case T:t.right.deleted||jt(t.currentAttributes,t.right.content);break;default:t.right.deleted||(n<t.right.length&&O(e,m(t.right.id.client,t.right.id.clock+n)),t.index+=t.right.length,n-=t.right.length);break}t.left=t.right,t.right=t.right.right}return t},Ae=(e,t,n)=>{const s=new Map,r=tn(t,n);if(r){const i=new vn(r.p.left,r.p,r.index,s);return Ys(e,i,n-r.index)}else{const i=new vn(null,t._start,0,s);return Ys(e,i,n)}},ri=(e,t,n,s)=>{for(;n.right!==null&&(n.right.deleted===!0||n.right.content.constructor===T&&ht(s.get(n.right.content.key),n.right.content.value));)n.right.deleted||s.delete(n.right.content.key),n.forward();const r=e.doc,i=r.clientID;s.forEach((o,c)=>{const l=n.left,a=n.right,h=new k(m(i,D(r.store,i)),l,l&&l.lastId,a,a&&a.id,t,null,new T(c,o));h.integrate(e,0),n.right=h,n.forward()})},jt=(e,t)=>{const{key:n,value:s}=t;s===null?e.delete(n):e.set(n,s)},ii=(e,t)=>{for(;e.right!==null;){if(!(e.right.deleted||e.right.content.constructor===T&&ht(t[e.right.content.key]||null,e.right.content.value)))break;e.forward()}},oi=(e,t,n,s)=>{const r=e.doc,i=r.clientID,o=new Map;for(const c in s){const l=s[c],a=n.currentAttributes.get(c)||null;if(!ht(a,l)){o.set(c,a);const{left:h,right:u}=n;n.right=new k(m(i,D(r.store,i)),h,h&&h.lastId,u,u&&u.id,t,null,new T(c,l)),n.right.integrate(e,0),n.forward()}}return o},gn=(e,t,n,s,r)=>{n.currentAttributes.forEach((d,f)=>{r[f]===void 0&&(r[f]=null)});const i=e.doc,o=i.clientID;ii(n,r);const c=oi(e,t,n,r),l=s.constructor===String?new J(s):s instanceof x?new Y(s):new _t(s);let{left:a,right:h,index:u}=n;t._searchMarker&&re(t._searchMarker,n.index,l.getLength()),h=new k(m(o,D(i.store,o)),a,a&&a.lastId,h,h&&h.id,t,null,l),h.integrate(e,0),n.right=h,n.index=u,n.forward(),ri(e,t,n,c)},Gs=(e,t,n,s,r)=>{const i=e.doc,o=i.clientID;ii(n,r);const c=oi(e,t,n,r);t:for(;n.right!==null&&(s>0||c.size>0&&(n.right.deleted||n.right.content.constructor===T));){if(!n.right.deleted)switch(n.right.content.constructor){case T:{const{key:l,value:a}=n.right.content,h=r[l];if(h!==void 0){if(ht(h,a))c.delete(l);else{if(s===0)break t;c.set(l,a)}n.right.delete(e)}else n.currentAttributes.set(l,a);break}default:s<n.right.length&&O(e,m(n.right.id.client,n.right.id.clock+s)),s-=n.right.length;break}n.forward()}if(s>0){let l="";for(;s>0;s--)l+=`
`;n.right=new k(m(o,D(i.store,o)),n.left,n.left&&n.left.lastId,n.right,n.right&&n.right.id,t,null,new J(l)),n.right.integrate(e,0),n.forward()}ri(e,t,n,c)},ci=(e,t,n,s,r)=>{let i=t;const o=F();for(;i&&(!i.countable||i.deleted);){if(!i.deleted&&i.content.constructor===T){const a=i.content;o.set(a.key,a)}i=i.right}let c=0,l=!1;for(;t!==i;){if(n===t&&(l=!0),!t.deleted){const a=t.content;switch(a.constructor){case T:{const{key:h,value:u}=a,d=s.get(h)||null;(o.get(h)!==a||d===u)&&(t.delete(e),c++,!l&&(r.get(h)||null)===u&&d!==u&&(d===null?r.delete(h):r.set(h,d))),!l&&!t.deleted&&jt(r,a);break}}}t=t.right}return c},ta=(e,t)=>{for(;t&&t.right&&(t.right.deleted||!t.right.countable);)t=t.right;const n=new Set;for(;t&&(t.deleted||!t.countable);){if(!t.deleted&&t.content.constructor===T){const s=t.content.key;n.has(s)?t.delete(e):n.add(s)}t=t.left}},ea=e=>{let t=0;return _(e.doc,n=>{let s=e._start,r=e._start,i=F();const o=Sn(i);for(;r;){if(r.deleted===!1)switch(r.content.constructor){case T:jt(o,r.content);break;default:t+=ci(n,s,r,i,o),i=Sn(o),s=r;break}r=r.right}}),t},Ws=(e,t,n)=>{const s=n,r=Sn(t.currentAttributes),i=t.right;for(;n>0&&t.right!==null;){if(t.right.deleted===!1)switch(t.right.content.constructor){case Y:case _t:case J:n<t.right.length&&O(e,m(t.right.id.client,t.right.id.clock+n)),n-=t.right.length,t.right.delete(e);break}t.forward()}i&&ci(e,i,t.right,r,t.currentAttributes);const o=(t.left||t.right).parent;return o._searchMarker&&re(o._searchMarker,t.index,-s+n),t};class na extends Ze{constructor(t,n,s){super(t,n),this.childListChanged=!1,this.keysChanged=new Set,s.forEach(r=>{r===null?this.childListChanged=!0:this.keysChanged.add(r)})}get changes(){if(this._changes===null){const t={keys:this.keys,delta:this.delta,added:new Set,deleted:new Set};this._changes=t}return this._changes}get delta(){if(this._delta===null){const t=this.target.doc,n=[];_(t,s=>{const r=new Map,i=new Map;let o=this.target._start,c=null;const l={};let a="",h=0,u=0;const d=()=>{if(c!==null){let f=null;switch(c){case"delete":u>0&&(f={delete:u}),u=0;break;case"insert":(typeof a=="object"||a.length>0)&&(f={insert:a},r.size>0&&(f.attributes={},r.forEach((g,p)=>{g!==null&&(f.attributes[p]=g)}))),a="";break;case"retain":h>0&&(f={retain:h},hc(l)||(f.attributes=lc({},l))),h=0;break}f&&n.push(f),c=null}};for(;o!==null;){switch(o.content.constructor){case Y:case _t:this.adds(o)?this.deletes(o)||(d(),c="insert",a=o.content.getContent()[0],d()):this.deletes(o)?(c!=="delete"&&(d(),c="delete"),u+=1):o.deleted||(c!=="retain"&&(d(),c="retain"),h+=1);break;case J:this.adds(o)?this.deletes(o)||(c!=="insert"&&(d(),c="insert"),a+=o.content.str):this.deletes(o)?(c!=="delete"&&(d(),c="delete"),u+=o.length):o.deleted||(c!=="retain"&&(d(),c="retain"),h+=o.length);break;case T:{const{key:f,value:g}=o.content;if(this.adds(o)){if(!this.deletes(o)){const p=r.get(f)||null;ht(p,g)?g!==null&&o.delete(s):(c==="retain"&&d(),ht(g,i.get(f)||null)?delete l[f]:l[f]=g)}}else if(this.deletes(o)){i.set(f,g);const p=r.get(f)||null;ht(p,g)||(c==="retain"&&d(),l[f]=p)}else if(!o.deleted){i.set(f,g);const p=l[f];p!==void 0&&(ht(p,g)?p!==null&&o.delete(s):(c==="retain"&&d(),g===null?delete l[f]:l[f]=g))}o.deleted||(c==="insert"&&d(),jt(r,o.content));break}}o=o.right}for(d();n.length>0;){const f=n[n.length-1];if(f.retain!==void 0&&f.attributes===void 0)n.pop();else break}}),this._delta=n}return this._delta}}class bt extends x{constructor(t){super(),this._pending=t!==void 0?[()=>this.insert(0,t)]:[],this._searchMarker=[]}get length(){return this._length}_integrate(t,n){super._integrate(t,n);try{this._pending.forEach(s=>s())}catch(s){console.error(s)}this._pending=null}_copy(){return new bt}clone(){const t=new bt;return t.applyDelta(this.toDelta()),t}_callObserver(t,n){super._callObserver(t,n);const s=new na(this,t,n),r=t.doc;if(en(this,t,s),!t.local){let i=!1;for(const[o,c]of t.afterState.entries()){const l=t.beforeState.get(o)||0;if(c!==l&&(zr(t,r.store.clients.get(o),l,c,a=>{!a.deleted&&a.content.constructor===T&&(i=!0)}),i))break}i||ot(t,t.deleteSet,o=>{o instanceof B||i||o.parent===this&&o.content.constructor===T&&(i=!0)}),_(r,o=>{i?ea(this):ot(o,o.deleteSet,c=>{c instanceof B||c.parent===this&&ta(o,c)})})}}toString(){let t="",n=this._start;for(;n!==null;)!n.deleted&&n.countable&&n.content.constructor===J&&(t+=n.content.str),n=n.right;return t}toJSON(){return this.toString()}applyDelta(t,{sanitize:n=!0}={}){this.doc!==null?_(this.doc,s=>{const r=new vn(null,this._start,0,new Map);for(let i=0;i<t.length;i++){const o=t[i];if(o.insert!==void 0){const c=!n&&typeof o.insert=="string"&&i===t.length-1&&r.right===null&&o.insert.slice(-1)===`
`?o.insert.slice(0,-1):o.insert;(typeof c!="string"||c.length>0)&&gn(s,this,r,c,o.attributes||{})}else o.retain!==void 0?Gs(s,this,r,o.retain,o.attributes||{}):o.delete!==void 0&&Ws(s,r,o.delete)}}):this._pending.push(()=>this.applyDelta(t))}toDelta(t,n,s){const r=[],i=new Map,o=this.doc;let c="",l=this._start;function a(){if(c.length>0){const u={};let d=!1;i.forEach((g,p)=>{d=!0,u[p]=g});const f={insert:c};d&&(f.attributes=u),r.push(f),c=""}}const h=()=>{for(;l!==null;){if(Dt(l,t)||n!==void 0&&Dt(l,n))switch(l.content.constructor){case J:{const u=i.get("ychange");t!==void 0&&!Dt(l,t)?(u===void 0||u.user!==l.id.client||u.type!=="removed")&&(a(),i.set("ychange",s?s("removed",l.id):{type:"removed"})):n!==void 0&&!Dt(l,n)?(u===void 0||u.user!==l.id.client||u.type!=="added")&&(a(),i.set("ychange",s?s("added",l.id):{type:"added"})):u!==void 0&&(a(),i.delete("ychange")),c+=l.content.str;break}case Y:case _t:{a();const u={insert:l.content.getContent()[0]};if(i.size>0){const d={};u.attributes=d,i.forEach((f,g)=>{d[g]=f})}r.push(u);break}case T:Dt(l,t)&&(a(),jt(i,l.content));break}l=l.right}a()};return t||n?_(o,u=>{t&&In(u,t),n&&In(u,n),h()},"cleanup"):h(),r}insert(t,n,s){if(n.length<=0)return;const r=this.doc;r!==null?_(r,i=>{const o=Ae(i,this,t);s||(s={},o.currentAttributes.forEach((c,l)=>{s[l]=c})),gn(i,this,o,n,s)}):this._pending.push(()=>this.insert(t,n,s))}insertEmbed(t,n,s={}){const r=this.doc;r!==null?_(r,i=>{const o=Ae(i,this,t);gn(i,this,o,n,s)}):this._pending.push(()=>this.insertEmbed(t,n,s))}delete(t,n){if(n===0)return;const s=this.doc;s!==null?_(s,r=>{Ws(r,Ae(r,this,t),n)}):this._pending.push(()=>this.delete(t,n))}format(t,n,s){if(n===0)return;const r=this.doc;r!==null?_(r,i=>{const o=Ae(i,this,t);o.right!==null&&Gs(i,this,o,n,s)}):this._pending.push(()=>this.format(t,n,s))}removeAttribute(t){this.doc!==null?_(this.doc,n=>{Be(n,this,t)}):this._pending.push(()=>this.removeAttribute(t))}setAttribute(t,n){this.doc!==null?_(this.doc,s=>{as(s,this,t,n)}):this._pending.push(()=>this.setAttribute(t,n))}getAttribute(t){return hs(this,t)}getAttributes(){return ni(this)}_write(t){t.writeTypeRef(ka)}}const sa=e=>new bt;class pn{constructor(t,n=()=>!0){this._filter=n,this._root=t,this._currentNode=t._start,this._firstCall=!0}[Symbol.iterator](){return this}next(){let t=this._currentNode,n=t&&t.content&&t.content.type;if(t!==null&&(!this._firstCall||t.deleted||!this._filter(n)))do if(n=t.content.type,!t.deleted&&(n.constructor===L||n.constructor===St)&&n._start!==null)t=n._start;else for(;t!==null;)if(t.right!==null){t=t.right;break}else t.parent===this._root?t=null:t=t.parent._item;while(t!==null&&(t.deleted||!this._filter(t.content.type)));return this._firstCall=!1,t===null?{value:void 0,done:!0}:(this._currentNode=t,{value:t.content.type,done:!1})}}class St extends x{constructor(){super(),this._prelimContent=[]}get firstChild(){const t=this._first;return t?t.content.getContent()[0]:null}_integrate(t,n){super._integrate(t,n),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new St}clone(){const t=new St;return t.insert(0,this.toArray().map(n=>n instanceof x?n.clone():n)),t}get length(){return this._prelimContent===null?this._length:this._prelimContent.length}createTreeWalker(t){return new pn(this,t)}querySelector(t){t=t.toUpperCase();const s=new pn(this,r=>r.nodeName&&r.nodeName.toUpperCase()===t).next();return s.done?null:s.value}querySelectorAll(t){return t=t.toUpperCase(),dt(new pn(this,n=>n.nodeName&&n.nodeName.toUpperCase()===t))}_callObserver(t,n){en(this,t,new oa(this,n,t))}toString(){return Xr(this,t=>t.toString()).join("")}toJSON(){return this.toString()}toDOM(t=document,n={},s){const r=t.createDocumentFragment();return s!==void 0&&s._createAssociation(r,this),ie(this,i=>{r.insertBefore(i.toDOM(t,n,s),null)}),r}insert(t,n){this.doc!==null?_(this.doc,s=>{ti(s,this,t,n)}):this._prelimContent.splice(t,0,...n)}insertAfter(t,n){if(this.doc!==null)_(this.doc,s=>{const r=t&&t instanceof x?t._item:t;Ve(s,this,r,n)});else{const s=this._prelimContent,r=t===null?0:s.findIndex(i=>i===t)+1;if(r===0&&t!==null)throw Nt("Reference item not found");s.splice(r,0,...n)}}delete(t,n=1){this.doc!==null?_(this.doc,s=>{ei(s,this,t,n)}):this._prelimContent.splice(t,n)}toArray(){return Wr(this)}push(t){this.insert(this.length,t)}unshift(t){this.insert(0,t)}get(t){return Qr(this,t)}slice(t=0,n=this.length){return Gr(this,t,n)}forEach(t){ie(this,t)}_write(t){t.writeTypeRef(_a)}}const ra=e=>new St;class L extends St{constructor(t="UNDEFINED"){super(),this.nodeName=t,this._prelimAttrs=new Map}get nextSibling(){const t=this._item?this._item.next:null;return t?t.content.type:null}get prevSibling(){const t=this._item?this._item.prev:null;return t?t.content.type:null}_integrate(t,n){super._integrate(t,n),this._prelimAttrs.forEach((s,r)=>{this.setAttribute(r,s)}),this._prelimAttrs=null}_copy(){return new L(this.nodeName)}clone(){const t=new L(this.nodeName),n=this.getAttributes();return ac(n,(s,r)=>{typeof s=="string"&&t.setAttribute(r,s)}),t.insert(0,this.toArray().map(s=>s instanceof x?s.clone():s)),t}toString(){const t=this.getAttributes(),n=[],s=[];for(const c in t)s.push(c);s.sort();const r=s.length;for(let c=0;c<r;c++){const l=s[c];n.push(l+'="'+t[l]+'"')}const i=this.nodeName.toLocaleLowerCase(),o=n.length>0?" "+n.join(" "):"";return`<${i}${o}>${super.toString()}</${i}>`}removeAttribute(t){this.doc!==null?_(this.doc,n=>{Be(n,this,t)}):this._prelimAttrs.delete(t)}setAttribute(t,n){this.doc!==null?_(this.doc,s=>{as(s,this,t,n)}):this._prelimAttrs.set(t,n)}getAttribute(t){return hs(this,t)}hasAttribute(t){return si(this,t)}getAttributes(){return ni(this)}toDOM(t=document,n={},s){const r=t.createElement(this.nodeName),i=this.getAttributes();for(const o in i){const c=i[o];typeof c=="string"&&r.setAttribute(o,c)}return ie(this,o=>{r.appendChild(o.toDOM(t,n,s))}),s!==void 0&&s._createAssociation(r,this),r}_write(t){t.writeTypeRef(Ca),t.writeKey(this.nodeName)}}const ia=e=>new L(e.readKey());class oa extends Ze{constructor(t,n,s){super(t,s),this.childListChanged=!1,this.attributesChanged=new Set,n.forEach(r=>{r===null?this.childListChanged=!0:this.attributesChanged.add(r)})}}class Pe extends Rt{constructor(t){super(),this.hookName=t}_copy(){return new Pe(this.hookName)}clone(){const t=new Pe(this.hookName);return this.forEach((n,s)=>{t.set(s,n)}),t}toDOM(t=document,n={},s){const r=n[this.hookName];let i;return r!==void 0?i=r.createDom(this):i=document.createElement(this.hookName),i.setAttribute("data-yjs-hook",this.hookName),s!==void 0&&s._createAssociation(i,this),i}_write(t){t.writeTypeRef(Aa),t.writeKey(this.hookName)}}const ca=e=>new Pe(e.readKey());class V extends bt{get nextSibling(){const t=this._item?this._item.next:null;return t?t.content.type:null}get prevSibling(){const t=this._item?this._item.prev:null;return t?t.content.type:null}_copy(){return new V}clone(){const t=new V;return t.applyDelta(this.toDelta()),t}toDOM(t=document,n,s){const r=t.createTextNode(this.toString());return s!==void 0&&s._createAssociation(r,this),r}toString(){return this.toDelta().map(t=>{const n=[];for(const r in t.attributes){const i=[];for(const o in t.attributes[r])i.push({key:o,value:t.attributes[r][o]});i.sort((o,c)=>o.key<c.key?-1:1),n.push({nodeName:r,attrs:i})}n.sort((r,i)=>r.nodeName<i.nodeName?-1:1);let s="";for(let r=0;r<n.length;r++){const i=n[r];s+=`<${i.nodeName}`;for(let o=0;o<i.attrs.length;o++){const c=i.attrs[o];s+=` ${c.key}="${c.value}"`}s+=">"}s+=t.insert;for(let r=n.length-1;r>=0;r--)s+=`</${n[r].nodeName}>`;return s}).join("")}toJSON(){return this.toString()}_write(t){t.writeTypeRef(Da)}}const la=e=>new V;class us{constructor(t,n){this.id=t,this.length=n}get deleted(){throw H()}mergeWith(t){return!1}write(t,n,s){throw H()}integrate(t,n){throw H()}}const aa=0;class B extends us{get deleted(){return!0}delete(){}mergeWith(t){return this.constructor!==t.constructor?!1:(this.length+=t.length,!0)}integrate(t,n){n>0&&(this.id.clock+=n,this.length-=n),jr(t.doc.store,this)}write(t,n){t.writeInfo(aa),t.writeLen(this.length-n)}getMissing(t,n){return null}}class we{constructor(t){this.content=t}getLength(){return 1}getContent(){return[this.content]}isCountable(){return!0}copy(){return new we(this.content)}splice(t){throw H()}mergeWith(t){return!1}integrate(t,n){}delete(t){}gc(t){}write(t,n){t.writeBuf(this.content)}getRef(){return 3}}const ha=e=>new we(e.readBuf());class oe{constructor(t){this.len=t}getLength(){return this.len}getContent(){return[]}isCountable(){return!1}copy(){return new oe(this.len)}splice(t){const n=new oe(this.len-t);return this.len=t,n}mergeWith(t){return this.len+=t.len,!0}integrate(t,n){te(t.deleteSet,n.id.client,n.id.clock,this.len),n.markDeleted()}delete(t){}gc(t){}write(t,n){t.writeLen(this.len-n)}getRef(){return 1}}const ua=e=>new oe(e.readLen()),li=(e,t)=>new Ct({guid:e,...t,shouldLoad:t.shouldLoad||t.autoLoad||!1});class ye{constructor(t){t._item&&console.error("This document was already integrated as a sub-document. You should create a second instance instead with the same guid."),this.doc=t;const n={};this.opts=n,t.gc||(n.gc=!1),t.autoLoad&&(n.autoLoad=!0),t.meta!==null&&(n.meta=t.meta)}getLength(){return 1}getContent(){return[this.doc]}isCountable(){return!0}copy(){return new ye(li(this.doc.guid,this.opts))}splice(t){throw H()}mergeWith(t){return!1}integrate(t,n){this.doc._item=n,t.subdocsAdded.add(this.doc),this.doc.shouldLoad&&t.subdocsLoaded.add(this.doc)}delete(t){t.subdocsAdded.has(this.doc)?t.subdocsAdded.delete(this.doc):t.subdocsRemoved.add(this.doc)}gc(t){}write(t,n){t.writeString(this.doc.guid),t.writeAny(this.opts)}getRef(){return 9}}const da=e=>new ye(li(e.readString(),e.readAny()));class _t{constructor(t){this.embed=t}getLength(){return 1}getContent(){return[this.embed]}isCountable(){return!0}copy(){return new _t(this.embed)}splice(t){throw H()}mergeWith(t){return!1}integrate(t,n){}delete(t){}gc(t){}write(t,n){t.writeJSON(this.embed)}getRef(){return 5}}const fa=e=>new _t(e.readJSON());class T{constructor(t,n){this.key=t,this.value=n}getLength(){return 1}getContent(){return[]}isCountable(){return!1}copy(){return new T(this.key,this.value)}splice(t){throw H()}mergeWith(t){return!1}integrate(t,n){n.parent._searchMarker=null}delete(t){}gc(t){}write(t,n){t.writeKey(this.key),t.writeJSON(this.value)}getRef(){return 6}}const ga=e=>new T(e.readKey(),e.readJSON());class Fe{constructor(t){this.arr=t}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new Fe(this.arr)}splice(t){const n=new Fe(this.arr.slice(t));return this.arr=this.arr.slice(0,t),n}mergeWith(t){return this.arr=this.arr.concat(t.arr),!0}integrate(t,n){}delete(t){}gc(t){}write(t,n){const s=this.arr.length;t.writeLen(s-n);for(let r=n;r<s;r++){const i=this.arr[r];t.writeString(i===void 0?"undefined":JSON.stringify(i))}}getRef(){return 2}}const pa=e=>{const t=e.readLen(),n=[];for(let s=0;s<t;s++){const r=e.readString();r==="undefined"?n.push(void 0):n.push(JSON.parse(r))}return new Fe(n)};class kt{constructor(t){this.arr=t}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new kt(this.arr)}splice(t){const n=new kt(this.arr.slice(t));return this.arr=this.arr.slice(0,t),n}mergeWith(t){return this.arr=this.arr.concat(t.arr),!0}integrate(t,n){}delete(t){}gc(t){}write(t,n){const s=this.arr.length;t.writeLen(s-n);for(let r=n;r<s;r++){const i=this.arr[r];t.writeAny(i)}}getRef(){return 8}}const ma=e=>{const t=e.readLen(),n=[];for(let s=0;s<t;s++)n.push(e.readAny());return new kt(n)};class J{constructor(t){this.str=t}getLength(){return this.str.length}getContent(){return this.str.split("")}isCountable(){return!0}copy(){return new J(this.str)}splice(t){const n=new J(this.str.slice(t));this.str=this.str.slice(0,t);const s=this.str.charCodeAt(t-1);return s>=55296&&s<=56319&&(this.str=this.str.slice(0,t-1)+"�",n.str="�"+n.str.slice(1)),n}mergeWith(t){return this.str+=t.str,!0}integrate(t,n){}delete(t){}gc(t){}write(t,n){t.writeString(n===0?this.str:this.str.slice(n))}getRef(){return 4}}const wa=e=>new J(e.readString()),ya=[Xl,Zl,sa,ia,ra,ca,la],ba=0,Sa=1,ka=2,Ca=3,_a=4,Aa=5,Da=6;class Y{constructor(t){this.type=t}getLength(){return 1}getContent(){return[this.type]}isCountable(){return!0}copy(){return new Y(this.type._copy())}splice(t){throw H()}mergeWith(t){return!1}integrate(t,n){this.type._integrate(t.doc,n)}delete(t){let n=this.type._start;for(;n!==null;)n.deleted?t._mergeStructs.push(n):n.delete(t),n=n.right;this.type._map.forEach(s=>{s.deleted?t._mergeStructs.push(s):s.delete(t)}),t.changed.delete(this.type)}gc(t){let n=this.type._start;for(;n!==null;)n.gc(t,!0),n=n.right;this.type._start=null,this.type._map.forEach(s=>{for(;s!==null;)s.gc(t,!0),s=s.left}),this.type._map=new Map}write(t,n){this.type._write(t)}getRef(){return 7}}const Ea=e=>new Y(ya[e.readTypeRef()](e)),Mn=(e,t)=>{let n=t,s=0,r;do s>0&&(n=m(n.client,n.clock+s)),r=ve(e,n),s=n.clock-r.id.clock,n=r.redone;while(n!==null&&r instanceof k);return{item:r,diff:s}},ds=(e,t)=>{for(;e!==null&&e.keep!==t;)e.keep=t,e=e.parent._item},je=(e,t,n)=>{const{client:s,clock:r}=t.id,i=new k(m(s,r+n),t,m(s,r+n-1),t.right,t.rightOrigin,t.parent,t.parentSub,t.content.splice(n));return t.deleted&&i.markDeleted(),t.keep&&(i.keep=!0),t.redone!==null&&(i.redone=m(t.redone.client,t.redone.clock+n)),t.right=i,i.right!==null&&(i.right.left=i),e._mergeStructs.push(i),i.parentSub!==null&&i.right===null&&i.parent._map.set(i.parentSub,i),t.length=n,i},Ks=(e,t)=>Xo(e,n=>Pt(n.deletions,t)),ai=(e,t,n,s,r,i)=>{const o=e.doc,c=o.store,l=o.clientID,a=t.redone;if(a!==null)return O(e,a);let h=t.parent._item,u=null,d;if(h!==null&&h.deleted===!0){if(h.redone===null&&(!n.has(h)||ai(e,h,n,s,r,i)===null))return null;for(;h.redone!==null;)h=O(e,h.redone)}const f=h===null?t.parent:h.content.type;if(t.parentSub===null){for(u=t.left,d=t;u!==null;){let S=u;for(;S!==null&&S.parent._item!==h;)S=S.redone===null?null:O(e,S.redone);if(S!==null&&S.parent._item===h){u=S;break}u=u.left}for(;d!==null;){let S=d;for(;S!==null&&S.parent._item!==h;)S=S.redone===null?null:O(e,S.redone);if(S!==null&&S.parent._item===h){d=S;break}d=d.right}}else if(d=null,t.right&&!r){for(u=t;u!==null&&u.right!==null&&(u.right.redone||Pt(s,u.right.id)||Ks(i.undoStack,u.right.id)||Ks(i.redoStack,u.right.id));)for(u=u.right;u.redone;)u=O(e,u.redone);if(u&&u.right!==null)return null}else u=f._map.get(t.parentSub)||null;const g=D(c,l),p=m(l,g),b=new k(p,u,u&&u.lastId,d,d&&d.id,f,t.parentSub,t.content.copy());return t.redone=p,ds(b,!0),b.integrate(e,0),b};class k extends us{constructor(t,n,s,r,i,o,c,l){super(t,l.getLength()),this.origin=s,this.left=n,this.right=r,this.rightOrigin=i,this.parent=o,this.parentSub=c,this.redone=null,this.content=l,this.info=this.content.isCountable()?vs:0}set marker(t){(this.info&an)>0!==t&&(this.info^=an)}get marker(){return(this.info&an)>0}get keep(){return(this.info&Us)>0}set keep(t){this.keep!==t&&(this.info^=Us)}get countable(){return(this.info&vs)>0}get deleted(){return(this.info&ln)>0}set deleted(t){this.deleted!==t&&(this.info^=ln)}markDeleted(){this.info|=ln}getMissing(t,n){if(this.origin&&this.origin.client!==this.id.client&&this.origin.clock>=D(n,this.origin.client))return this.origin.client;if(this.rightOrigin&&this.rightOrigin.client!==this.id.client&&this.rightOrigin.clock>=D(n,this.rightOrigin.client))return this.rightOrigin.client;if(this.parent&&this.parent.constructor===Ut&&this.id.client!==this.parent.client&&this.parent.clock>=D(n,this.parent.client))return this.parent.client;if(this.origin&&(this.left=js(t,n,this.origin),this.origin=this.left.lastId),this.rightOrigin&&(this.right=O(t,this.rightOrigin),this.rightOrigin=this.right.id),(this.left&&this.left.constructor===B||this.right&&this.right.constructor===B)&&(this.parent=null),!this.parent)this.left&&this.left.constructor===k&&(this.parent=this.left.parent,this.parentSub=this.left.parentSub),this.right&&this.right.constructor===k&&(this.parent=this.right.parent,this.parentSub=this.right.parentSub);else if(this.parent.constructor===Ut){const s=ve(n,this.parent);s.constructor===B?this.parent=null:this.parent=s.content.type}return null}integrate(t,n){if(n>0&&(this.id.clock+=n,this.left=js(t,t.doc.store,m(this.id.client,this.id.clock-1)),this.origin=this.left.lastId,this.content=this.content.splice(n),this.length-=n),this.parent){if(!this.left&&(!this.right||this.right.left!==null)||this.left&&this.left.right!==this.right){let s=this.left,r;if(s!==null)r=s.right;else if(this.parentSub!==null)for(r=this.parent._map.get(this.parentSub)||null;r!==null&&r.left!==null;)r=r.left;else r=this.parent._start;const i=new Set,o=new Set;for(;r!==null&&r!==this.right;){if(o.add(r),i.add(r),Et(this.origin,r.origin)){if(r.id.client<this.id.client)s=r,i.clear();else if(Et(this.rightOrigin,r.rightOrigin))break}else if(r.origin!==null&&o.has(ve(t.doc.store,r.origin)))i.has(ve(t.doc.store,r.origin))||(s=r,i.clear());else break;r=r.right}this.left=s}if(this.left!==null){const s=this.left.right;this.right=s,this.left.right=this}else{let s;if(this.parentSub!==null)for(s=this.parent._map.get(this.parentSub)||null;s!==null&&s.left!==null;)s=s.left;else s=this.parent._start,this.parent._start=this;this.right=s}this.right!==null?this.right.left=this:this.parentSub!==null&&(this.parent._map.set(this.parentSub,this),this.left!==null&&this.left.delete(t)),this.parentSub===null&&this.countable&&!this.deleted&&(this.parent._length+=this.length),jr(t.doc.store,this),this.content.integrate(t,this),Hs(t,this.parent,this.parentSub),(this.parent._item!==null&&this.parent._item.deleted||this.parentSub!==null&&this.right!==null)&&this.delete(t)}else new B(this.id,this.length).integrate(t,0)}get next(){let t=this.right;for(;t!==null&&t.deleted;)t=t.right;return t}get prev(){let t=this.left;for(;t!==null&&t.deleted;)t=t.left;return t}get lastId(){return this.length===1?this.id:m(this.id.client,this.id.clock+this.length-1)}mergeWith(t){if(this.constructor===t.constructor&&Et(t.origin,this.lastId)&&this.right===t&&Et(this.rightOrigin,t.rightOrigin)&&this.id.client===t.id.client&&this.id.clock+this.length===t.id.clock&&this.deleted===t.deleted&&this.redone===null&&t.redone===null&&this.content.constructor===t.content.constructor&&this.content.mergeWith(t.content)){const n=this.parent._searchMarker;return n&&n.forEach(s=>{s.p===t&&(s.p=this,!this.deleted&&this.countable&&(s.index-=this.length))}),t.keep&&(this.keep=!0),this.right=t.right,this.right!==null&&(this.right.left=this),this.length+=t.length,!0}return!1}delete(t){if(!this.deleted){const n=this.parent;this.countable&&this.parentSub===null&&(n._length-=this.length),this.markDeleted(),te(t.deleteSet,this.id.client,this.id.clock,this.length),Hs(t,n,this.parentSub),this.content.delete(t)}}gc(t,n){if(!this.deleted)throw j();this.content.gc(t),n?xl(t,this,new B(this.id,this.length)):this.content=new oe(this.length)}write(t,n){const s=n>0?m(this.id.client,this.id.clock+n-1):this.origin,r=this.rightOrigin,i=this.parentSub,o=this.content.getRef()&We|(s===null?0:N)|(r===null?0:st)|(i===null?0:Xt);if(t.writeInfo(o),s!==null&&t.writeLeftID(s),r!==null&&t.writeRightID(r),s===null&&r===null){const c=this.parent;if(c._item!==void 0){const l=c._item;if(l===null){const a=ee(c);t.writeParentInfo(!0),t.writeString(a)}else t.writeParentInfo(!1),t.writeLeftID(l.id)}else c.constructor===String?(t.writeParentInfo(!0),t.writeString(c)):c.constructor===Ut?(t.writeParentInfo(!1),t.writeLeftID(c)):j();i!==null&&t.writeString(i)}this.content.write(t,n)}}const hi=(e,t)=>Ta[t&We](e),Ta=[()=>{j()},ua,pa,ha,wa,fa,ga,Ea,ma,da,()=>{j()}],Ia=10;class P extends us{get deleted(){return!0}delete(){}mergeWith(t){return this.constructor!==t.constructor?!1:(this.length+=t.length,!0)}integrate(t,n){j()}write(t,n){t.writeInfo(Ia),y(t.restEncoder,this.length-n)}getMissing(t,n){return null}}const ui=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:{},di="__ $YJS$ __";ui[di]===!0&&console.error("Yjs was already imported. This breaks constructor checks and will lead to issues! - https://github.com/yjs/yjs/issues/438");ui[di]=!0;const Ua=e=>e.toLowerCase(),va=/^\s*/g,Ma=e=>e.replace(va,""),xa=/([A-Z])/g,Xs=(e,t)=>Ma(e.replace(xa,n=>`${t}${Ua(n)}`)),Oa=e=>{const t=unescape(encodeURIComponent(e)),n=t.length,s=new Uint8Array(n);for(let r=0;r<n;r++)s[r]=t.codePointAt(r);return s},ce=typeof TextEncoder<"u"?new TextEncoder:null,La=e=>ce.encode(e),Ra=ce?La:Oa;let qt=typeof TextDecoder>"u"?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});qt&&qt.decode(new Uint8Array).length===1&&(qt=null);const mn=()=>new Map,Qs=e=>e===void 0?null:e;let $a=class{constructor(){this.map=new Map}setItem(t,n){this.map.set(t,n)}getItem(t){return this.map.get(t)}},fi=new $a,Na=!0;try{typeof localStorage<"u"&&(fi=localStorage,Na=!1)}catch{}const Va=fi,Ba=(e,t)=>t.includes(e),le=typeof process<"u"&&process.release&&/node|io\.js/.test(process.release.name);let W;const Pa=()=>{if(W===void 0)if(le){W=mn();const e=process.argv;let t=null;for(let n=0;n<e.length;n++){const s=e[n];s[0]==="-"?(t!==null&&W.set(t,""),t=s):t!==null&&(W.set(t,s),t=null)}t!==null&&W.set(t,"")}else typeof location=="object"?(W=mn(),(location.search||"?").slice(1).split("&").forEach(e=>{if(e.length!==0){const[t,n]=e.split("=");W.set(`--${Xs(t,"-")}`,n),W.set(`-${Xs(t,"-")}`,n)}})):W=mn();return W},xn=e=>Pa().has(e),On=e=>Qs(le?process.env[e.toUpperCase()]:Va.getItem(e)),Fa=e=>xn("--"+e)||On(e)!==null;Fa("production");const Zs=le&&Ba({}.FORCE_COLOR,["true","1","2"]);!xn("no-colors")&&(!le||process.stdout.isTTY||Zs)&&(!le||xn("color")||Zs||On("COLORTERM")!==null||(On("TERM")||"").includes("color"));const gi=128,xe=127,ja=Math.floor,za=(e,t)=>e<t?e:t,Ha=(e,t)=>e>t?e:t,Ja=Number.MAX_SAFE_INTEGER,pi=e=>new Error(e),qa=pi("Unexpected end of array"),Ya=pi("Integer out of Range"),Ga=(e,t)=>{const n=Za(e.arr.buffer,e.pos+e.arr.byteOffset,t);return e.pos+=t,n},Wa=e=>Ga(e,fs(e)),tr=e=>e.arr[e.pos++],fs=e=>{let t=0,n=1;const s=e.arr.length;for(;e.pos<s;){const r=e.arr[e.pos++];if(t=t+(r&xe)*n,n*=128,r<gi)return t;if(t>Ja)throw Ya}throw qa},Ka=e=>{let t=fs(e);if(t===0)return"";{let n=String.fromCodePoint(tr(e));if(--t<100)for(;t--;)n+=String.fromCodePoint(tr(e));else for(;t>0;){const s=t<1e4?t:1e4,r=e.arr.subarray(e.pos,e.pos+s);e.pos+=s,n+=String.fromCodePoint.apply(null,r),t-=s}return decodeURIComponent(escape(n))}},Xa=e=>qt.decode(Wa(e)),Qa=qt?Xa:Ka,Za=(e,t,n)=>new Uint8Array(e,t,n),ze=(e,t)=>{const n=e.cbuf.length;e.cpos===n&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(n*2),e.cpos=0),e.cbuf[e.cpos++]=t},nn=(e,t)=>{for(;t>xe;)ze(e,gi|xe&t),t=ja(t/128);ze(e,xe&t)},Ln=new Uint8Array(3e4),th=Ln.length/3,eh=(e,t)=>{if(t.length<th){const n=ce.encodeInto(t,Ln).written||0;nn(e,n);for(let s=0;s<n;s++)ze(e,Ln[s])}else ih(e,Ra(t))},nh=(e,t)=>{const n=unescape(encodeURIComponent(t)),s=n.length;nn(e,s);for(let r=0;r<s;r++)ze(e,n.codePointAt(r))},sh=ce&&ce.encodeInto?eh:nh,rh=(e,t)=>{const n=e.cbuf.length,s=e.cpos,r=za(n-s,t.length),i=t.length-r;e.cbuf.set(t.subarray(0,r),s),e.cpos+=r,i>0&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(Ha(n*2,i)),e.cbuf.set(t.subarray(r)),e.cpos=i)},ih=(e,t)=>{nn(e,t.byteLength),rh(e,t)};var ae;(function(e){e[e.Token=0]="Token",e[e.PermissionDenied=1]="PermissionDenied",e[e.Authenticated=2]="Authenticated"})(ae||(ae={}));const oh=(e,t)=>{nn(e,ae.Token),sh(e,t)},ch=(e,t,n)=>{switch(fs(e)){case ae.PermissionDenied:{t(Qa(e));break}case ae.Authenticated:{n();break}}},lh={code:1009,reason:"Message Too Big"},er={code:4401,reason:"Unauthorized"},ah={code:4403,reason:"Forbidden"},nr=e=>Array.from(e.entries()).map(([t,n])=>({clientId:t,...n}));var Rn;(function(e){e[e.Connecting=0]="Connecting",e[e.Open=1]="Open",e[e.Closing=2]="Closing",e[e.Closed=3]="Closed"})(Rn||(Rn={}));function hh(e){return e||(e={}),{delay:e.delay===void 0?200:e.delay,initialDelay:e.initialDelay===void 0?0:e.initialDelay,minDelay:e.minDelay===void 0?0:e.minDelay,maxDelay:e.maxDelay===void 0?0:e.maxDelay,factor:e.factor===void 0?0:e.factor,maxAttempts:e.maxAttempts===void 0?3:e.maxAttempts,timeout:e.timeout===void 0?0:e.timeout,jitter:e.jitter===!0,handleError:e.handleError===void 0?null:e.handleError,handleTimeout:e.handleTimeout===void 0?null:e.handleTimeout,beforeAttempt:e.beforeAttempt===void 0?null:e.beforeAttempt,calculateDelay:e.calculateDelay===void 0?null:e.calculateDelay}}async function sr(e){return new Promise((t,n)=>{setTimeout(t,e)})}function uh(e,t){let n=t.delay;if(n===0)return 0;if(t.factor&&(n*=Math.pow(t.factor,e.attemptNum-1),t.maxDelay!==0&&(n=Math.min(n,t.maxDelay))),t.jitter){const s=Math.ceil(t.minDelay),r=Math.floor(n);n=Math.floor(Math.random()*(r-s+1))+s}return Math.round(n)}async function dh(e,t){const n=hh(t);for(const c of["delay","initialDelay","minDelay","maxDelay","maxAttempts","timeout"]){const l=n[c];if(!Number.isInteger(l)||l<0)throw new Error(`Value for ${c} must be an integer greater than or equal to 0`)}if(n.factor.constructor!==Number||n.factor<0)throw new Error("Value for factor must be a number greater than or equal to 0");if(n.delay<n.minDelay)throw new Error(`delay cannot be less than minDelay (delay: ${n.delay}, minDelay: ${n.minDelay}`);const s={attemptNum:0,attemptsRemaining:n.maxAttempts?n.maxAttempts:-1,aborted:!1,abort(){s.aborted=!0}},r=n.calculateDelay||uh;async function i(){if(n.beforeAttempt&&n.beforeAttempt(s,n),s.aborted){const l=new Error("Attempt aborted");throw l.code="ATTEMPT_ABORTED",l}const c=async l=>{if(n.handleError&&await n.handleError(l,s,n),s.aborted||s.attemptsRemaining===0)throw l;s.attemptNum++;const a=r(s,n);return a&&await sr(a),i()};return s.attemptsRemaining>0&&s.attemptsRemaining--,n.timeout?new Promise((l,a)=>{const h=setTimeout(()=>{if(n.handleTimeout)try{l(n.handleTimeout(s,n))}catch(u){a(u)}else{const u=new Error(`Retry timeout (attemptNum: ${s.attemptNum}, timeout: ${n.timeout})`);u.code="ATTEMPT_TIMEOUT",a(u)}},n.timeout);e(s,n).then(u=>{clearTimeout(h),l(u)}).catch(u=>{clearTimeout(h),c(u).then(l).catch(a)})}):e(s,n).catch(c)}const o=n.calculateDelay?n.calculateDelay(s,n):n.initialDelay;return o&&await sr(o),i()}const Mt=()=>new Map,mi=(e,t,n)=>{let s=e.get(t);return s===void 0&&e.set(t,s=n()),s},wi=()=>new Set,fh=String.fromCharCode,gh=e=>e.toLowerCase(),ph=/^\s*/g,mh=e=>e.replace(ph,""),wh=/([A-Z])/g,rr=(e,t)=>mh(e.replace(wh,n=>`${t}${gh(n)}`)),yh=e=>{const t=unescape(encodeURIComponent(e)),n=t.length,s=new Uint8Array(n);for(let r=0;r<n;r++)s[r]=t.codePointAt(r);return s},he=typeof TextEncoder<"u"?new TextEncoder:null,bh=e=>he.encode(e),Sh=he?bh:yh;let Yt=typeof TextDecoder>"u"?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});Yt&&Yt.decode(new Uint8Array).length===1&&(Yt=null);const ir=e=>e===void 0?null:e;class kh{constructor(){this.map=new Map}setItem(t,n){this.map.set(t,n)}getItem(t){return this.map.get(t)}}let yi=new kh,gs=!0;try{typeof localStorage<"u"&&(yi=localStorage,gs=!1)}catch{}const bi=yi,Ch=e=>gs||addEventListener("storage",e),_h=e=>gs||removeEventListener("storage",e),Ah=Array.from,Dh=Object.keys,Eh=(e,t)=>{const n=[];for(const s in e)n.push(t(e[s],s));return n},or=e=>Dh(e).length,Th=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),Ih=(e,t)=>e===t,Gt=(e,t)=>{if(e==null||t==null)return Ih(e,t);if(e.constructor!==t.constructor)return!1;if(e===t)return!0;switch(e.constructor){case ArrayBuffer:e=new Uint8Array(e),t=new Uint8Array(t);case Uint8Array:{if(e.byteLength!==t.byteLength)return!1;for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!1;break}case Set:{if(e.size!==t.size)return!1;for(const n of e)if(!t.has(n))return!1;break}case Map:{if(e.size!==t.size)return!1;for(const n of e.keys())if(!t.has(n)||!Gt(e.get(n),t.get(n)))return!1;break}case Object:if(or(e)!==or(t))return!1;for(const n in e)if(!Th(e,n)||!Gt(e[n],t[n]))return!1;break;case Array:if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!Gt(e[n],t[n]))return!1;break;default:return!1}return!0},Uh=(e,t)=>t.includes(e),$t=typeof process<"u"&&process.release&&/node|io\.js/.test(process.release.name),Si=typeof window<"u"&&typeof document<"u"&&!$t;let K;const vh=()=>{if(K===void 0)if($t){K=Mt();const e=process.argv;let t=null;for(let n=0;n<e.length;n++){const s=e[n];s[0]==="-"?(t!==null&&K.set(t,""),t=s):t!==null&&(K.set(t,s),t=null)}t!==null&&K.set(t,"")}else typeof location=="object"?(K=Mt(),(location.search||"?").slice(1).split("&").forEach(e=>{if(e.length!==0){const[t,n]=e.split("=");K.set(`--${rr(t,"-")}`,n),K.set(`-${rr(t,"-")}`,n)}})):K=Mt();return K},$n=e=>vh().has(e),Nn=e=>ir($t?process.env[e.toUpperCase()]:bi.getItem(e)),Mh=e=>$n("--"+e)||Nn(e)!==null;Mh("production");const cr=$t&&Uh({}.FORCE_COLOR,["true","1","2"]);!$n("no-colors")&&(!$t||process.stdout.isTTY||cr)&&(!$t||$n("color")||cr||Nn("COLORTERM")!==null||(Nn("TERM")||"").includes("color"));const ki=Math.floor,xh=(e,t)=>e<t?e:t,Oh=(e,t)=>e>t?e:t,Ci=128,Oe=127,Lh=Number.MAX_SAFE_INTEGER;class Rh{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}}const ps=()=>new Rh,_i=e=>{let t=e.cpos;for(let n=0;n<e.bufs.length;n++)t+=e.bufs[n].length;return t},ms=e=>{const t=new Uint8Array(_i(e));let n=0;for(let s=0;s<e.bufs.length;s++){const r=e.bufs[s];t.set(r,n),n+=r.length}return t.set(Ei(e.cbuf.buffer,0,e.cpos),n),t},He=(e,t)=>{const n=e.cbuf.length;e.cpos===n&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(n*2),e.cpos=0),e.cbuf[e.cpos++]=t},U=(e,t)=>{for(;t>Oe;)He(e,Ci|Oe&t),t=ki(t/128);He(e,Oe&t)},Vn=new Uint8Array(3e4),$h=Vn.length/3,Nh=(e,t)=>{if(t.length<$h){const n=he.encodeInto(t,Vn).written||0;U(e,n);for(let s=0;s<n;s++)He(e,Vn[s])}else zt(e,Sh(t))},Vh=(e,t)=>{const n=unescape(encodeURIComponent(t)),s=n.length;U(e,s);for(let r=0;r<s;r++)He(e,n.codePointAt(r))},q=he&&he.encodeInto?Nh:Vh,Bh=(e,t)=>{const n=e.cbuf.length,s=e.cpos,r=xh(n-s,t.length),i=t.length-r;e.cbuf.set(t.subarray(0,r),s),e.cpos+=r,i>0&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(Oh(n*2,i)),e.cbuf.set(t.subarray(r)),e.cpos=i)},zt=(e,t)=>{U(e,t.byteLength),Bh(e,t)},Ai=e=>new Error(e),Ph=Ai("Unexpected end of array"),Fh=Ai("Integer out of Range");class jh{constructor(t){this.arr=t,this.pos=0}}const Di=e=>new jh(e),zh=(e,t)=>{const n=Ei(e.arr.buffer,e.pos+e.arr.byteOffset,t);return e.pos+=t,n},sn=e=>zh(e,mt(e)),lr=e=>e.arr[e.pos++],mt=e=>{let t=0,n=1;const s=e.arr.length;for(;e.pos<s;){const r=e.arr[e.pos++];if(t=t+(r&Oe)*n,n*=128,r<Ci)return t;if(t>Lh)throw Fh}throw Ph},Hh=e=>{let t=mt(e);if(t===0)return"";{let n=String.fromCodePoint(lr(e));if(--t<100)for(;t--;)n+=String.fromCodePoint(lr(e));else for(;t>0;){const s=t<1e4?t:1e4,r=e.arr.subarray(e.pos,e.pos+s);e.pos+=s,n+=String.fromCodePoint.apply(null,r),t-=s}return decodeURIComponent(escape(n))}},Jh=e=>Yt.decode(sn(e)),ws=Yt?Jh:Hh,qh=e=>new Uint8Array(e),Ei=(e,t,n)=>new Uint8Array(e,t,n),Yh=e=>new Uint8Array(e),Gh=e=>{let t="";for(let n=0;n<e.byteLength;n++)t+=fh(e[n]);return btoa(t)},Wh=e=>Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString("base64"),Kh=e=>{const t=atob(e),n=qh(t.length);for(let s=0;s<t.length;s++)n[s]=t.charCodeAt(s);return n},Xh=e=>{const t=Buffer.from(e,"base64");return new Uint8Array(t.buffer,t.byteOffset,t.byteLength)},Qh=Si?Gh:Wh,Zh=Si?Kh:Xh,Ti=new Map;class tu{constructor(t){this.room=t,this.onmessage=null,this._onChange=n=>n.key===t&&this.onmessage!==null&&this.onmessage({data:Zh(n.newValue||"")}),Ch(this._onChange)}postMessage(t){bi.setItem(this.room,Qh(Yh(t)))}close(){_h(this._onChange)}}const eu=typeof BroadcastChannel>"u"?tu:BroadcastChannel,ys=e=>mi(Ti,e,()=>{const t=wi(),n=new eu(e);return n.onmessage=s=>t.forEach(r=>r(s.data,"broadcastchannel")),{bc:n,subs:t}}),nu=(e,t)=>(ys(e).subs.add(t),t),su=(e,t)=>{const n=ys(e),s=n.subs.delete(t);return s&&n.subs.size===0&&(n.bc.close(),Ti.delete(e)),s},ru=(e,t,n=null)=>{const s=ys(e);s.bc.postMessage(t),s.subs.forEach(r=>r(t,n))},ue=Date.now;class iu{constructor(){this._observers=Mt()}on(t,n){mi(this._observers,t,wi).add(n)}once(t,n){const s=(...r)=>{this.off(t,s),n(...r)};this.on(t,s)}off(t,n){const s=this._observers.get(t);s!==void 0&&(s.delete(n),s.size===0&&this._observers.delete(t))}emit(t,n){return Ah((this._observers.get(t)||Mt()).values()).forEach(s=>s(...n))}destroy(){this._observers=Mt()}}const wn=3e4;let ou=class extends iu{constructor(t){super(),this.doc=t,this.clientID=t.clientID,this.states=new Map,this.meta=new Map,this._checkInterval=setInterval(()=>{const n=ue();this.getLocalState()!==null&&wn/2<=n-this.meta.get(this.clientID).lastUpdated&&this.setLocalState(this.getLocalState());const s=[];this.meta.forEach((r,i)=>{i!==this.clientID&&wn<=n-r.lastUpdated&&this.states.has(i)&&s.push(i)}),s.length>0&&Le(this,s,"timeout")},ki(wn/10)),t.on("destroy",()=>{this.destroy()}),this.setLocalState({})}destroy(){this.emit("destroy",[this]),this.setLocalState(null),super.destroy(),clearInterval(this._checkInterval)}getLocalState(){return this.states.get(this.clientID)||null}setLocalState(t){const n=this.clientID,s=this.meta.get(n),r=s===void 0?0:s.clock+1,i=this.states.get(n);t===null?this.states.delete(n):this.states.set(n,t),this.meta.set(n,{clock:r,lastUpdated:ue()});const o=[],c=[],l=[],a=[];t===null?a.push(n):i==null?t!=null&&o.push(n):(c.push(n),Gt(i,t)||l.push(n)),(o.length>0||l.length>0||a.length>0)&&this.emit("change",[{added:o,updated:l,removed:a},"local"]),this.emit("update",[{added:o,updated:c,removed:a},"local"])}setLocalStateField(t,n){const s=this.getLocalState();s!==null&&this.setLocalState({...s,[t]:n})}getStates(){return this.states}};const Le=(e,t,n)=>{const s=[];for(let r=0;r<t.length;r++){const i=t[r];if(e.states.has(i)){if(e.states.delete(i),i===e.clientID){const o=e.meta.get(i);e.meta.set(i,{clock:o.clock+1,lastUpdated:ue()})}s.push(i)}}s.length>0&&(e.emit("change",[{added:[],updated:[],removed:s},n]),e.emit("update",[{added:[],updated:[],removed:s},n]))},Bn=(e,t,n=e.states)=>{const s=t.length,r=ps();U(r,s);for(let i=0;i<s;i++){const o=t[i],c=n.get(o)||null,l=e.meta.get(o).clock;U(r,o),U(r,l),q(r,JSON.stringify(c))}return ms(r)},cu=(e,t,n)=>{const s=Di(t),r=ue(),i=[],o=[],c=[],l=[],a=mt(s);for(let h=0;h<a;h++){const u=mt(s);let d=mt(s);const f=JSON.parse(ws(s)),g=e.meta.get(u),p=e.states.get(u),b=g===void 0?0:g.clock;(b<d||b===d&&f===null&&e.states.has(u))&&(f===null?u===e.clientID&&e.getLocalState()!=null?d++:e.states.delete(u):e.states.set(u,f),e.meta.set(u,{clock:d,lastUpdated:r}),g===void 0&&f!==null?i.push(u):g!==void 0&&f===null?l.push(u):f!==null&&(Gt(f,p)||c.push(u),o.push(u)))}(i.length>0||c.length>0||l.length>0)&&e.emit("change",[{added:i,updated:c,removed:l},n]),(i.length>0||o.length>0||l.length>0)&&e.emit("update",[{added:i,updated:o,removed:l},n])},Ii=()=>{let e=!0;return(t,n)=>{if(e){e=!1;try{t()}finally{e=!0}}else n!==void 0&&n()}};class Ui{constructor(){this.callbacks={}}on(t,n){return this.callbacks[t]||(this.callbacks[t]=[]),this.callbacks[t].push(n),this}emit(t,...n){const s=this.callbacks[t];return s&&s.forEach(r=>r.apply(this,n)),this}off(t,n){const s=this.callbacks[t];return s&&(n?this.callbacks[t]=s.filter(r=>r!==n):delete this.callbacks[t]),this}removeAllListeners(){this.callbacks={}}}class yn{constructor(t){this.data=t,this.encoder=ps(),this.decoder=Di(new Uint8Array(this.data))}readVarUint(){return mt(this.decoder)}readVarString(){return ws(this.decoder)}readVarUint8Array(){return sn(this.decoder)}writeVarUint(t){return U(this.encoder,t)}writeVarString(t){return q(this.encoder,t)}writeVarUint8Array(t){return zt(this.encoder,t)}length(){return _i(this.encoder)}}const vi=0,Je=1,bs=2,lu=(e,t)=>{U(e,vi);const n=Dl(t);zt(e,n)},Mi=(e,t,n)=>{U(e,Je),zt(e,kl(t,n))},au=(e,t,n)=>Mi(t,n,sn(e)),xi=(e,t,n)=>{try{yl(t,sn(e),n)}catch(s){console.error("Caught error while handling a Yjs update",s)}},hu=(e,t)=>{U(e,bs),zt(e,t)},uu=xi,du=(e,t,n,s)=>{const r=mt(e);switch(r){case vi:au(e,t,n);break;case Je:xi(e,n,s);break;case bs:uu(e,n,s);break;default:throw new Error("Unknown message type")}return r};var M;(function(e){e[e.Sync=0]="Sync",e[e.Awareness=1]="Awareness",e[e.Auth=2]="Auth",e[e.QueryAwareness=3]="QueryAwareness",e[e.Stateless=5]="Stateless",e[e.CLOSE=7]="CLOSE"})(M||(M={}));var v;(function(e){e.Connecting="connecting",e.Connected="connected",e.Disconnected="disconnected"})(v||(v={}));class Z{constructor(){this.encoder=ps()}get(t){return t.encoder}toUint8Array(){return ms(this.encoder)}}class ar{constructor(t){this.broadcasted=!1,this.message=t}setBroadcasted(t){return this.broadcasted=t,this}apply(t,n=!0){const{message:s}=this,r=s.readVarUint(),i=s.length();switch(r){case M.Sync:this.applySyncMessage(t,n);break;case M.Awareness:this.applyAwarenessMessage(t);break;case M.Auth:this.applyAuthMessage(t);break;case M.QueryAwareness:this.applyQueryAwarenessMessage(t);break;case M.Stateless:t.receiveStateless(ws(s.decoder));break;default:throw new Error(`Can’t apply message of unknown type: ${r}`)}s.length()>i+1&&(this.broadcasted?t.broadcast(Z,{encoder:s.encoder}):t.send(Z,{encoder:s.encoder}))}applySyncMessage(t,n){const{message:s}=this;s.writeVarUint(M.Sync);const r=du(s.decoder,s.encoder,t.document,t);n&&r===Je&&(t.synced=!0),(r===bs||r===Je)&&t.unsyncedChanges>0&&t.updateUnsyncedChanges(-1)}applyAwarenessMessage(t){const{message:n}=this;cu(t.awareness,n.readVarUint8Array(),t)}applyAuthMessage(t){const{message:n}=this;ch(n.decoder,t.permissionDeniedHandler.bind(t),t.authenticatedHandler.bind(t))}applyQueryAwarenessMessage(t){const{message:n}=this;n.writeVarUint(M.Awareness),n.writeVarUint8Array(Bn(t.awareness,Array.from(t.awareness.getStates().keys())))}}class hr{constructor(t,n={}){this.message=new t,this.encoder=this.message.get(n)}create(){return ms(this.encoder)}send(t){t==null||t.send(this.create())}broadcast(t){ru(t,this.create())}}class bn extends Z{constructor(){super(...arguments),this.type=M.Sync,this.description="First sync step"}get(t){if(typeof t.document>"u")throw new Error("The sync step one message requires document as an argument");return q(this.encoder,t.documentName),U(this.encoder,this.type),lu(this.encoder,t.document),this.encoder}}class fu extends Z{constructor(){super(...arguments),this.type=M.Sync,this.description="Second sync step"}get(t){if(typeof t.document>"u")throw new Error("The sync step two message requires document as an argument");return q(this.encoder,t.documentName),U(this.encoder,this.type),Mi(this.encoder,t.document),this.encoder}}class gu extends Z{constructor(){super(...arguments),this.type=M.QueryAwareness,this.description="Queries awareness states"}get(t){return console.log("queryAwareness: writing string docName",t.documentName),console.log(this.encoder.cpos),q(this.encoder,t.documentName),U(this.encoder,this.type),this.encoder}}class pu extends Z{constructor(){super(...arguments),this.type=M.Auth,this.description="Authentication"}get(t){if(typeof t.token>"u")throw new Error("The authentication message requires `token` as an argument.");return q(this.encoder,t.documentName),U(this.encoder,this.type),oh(this.encoder,t.token),this.encoder}}class De extends Z{constructor(){super(...arguments),this.type=M.Awareness,this.description="Awareness states update"}get(t){if(typeof t.awareness>"u")throw new Error("The awareness message requires awareness as an argument");if(typeof t.clients>"u")throw new Error("The awareness message requires clients as an argument");q(this.encoder,t.documentName),U(this.encoder,this.type);let n;return t.states===void 0?n=Bn(t.awareness,t.clients):n=Bn(t.awareness,t.clients,t.states),zt(this.encoder,n),this.encoder}}class mu extends Z{constructor(){super(...arguments),this.type=M.Sync,this.description="A document update"}get(t){return q(this.encoder,t.documentName),U(this.encoder,this.type),hu(this.encoder,t.update),this.encoder}}const wu=e=>Eh(e,(t,n)=>`${encodeURIComponent(n)}=${encodeURIComponent(t)}`).join("&");class yu extends Ui{constructor(t){super(),this.configuration={url:"",document:void 0,awareness:void 0,WebSocketPolyfill:void 0,parameters:{},connect:!0,broadcast:!0,forceSyncInterval:!1,messageReconnectTimeout:3e4,delay:1e3,initialDelay:0,factor:2,maxAttempts:0,minDelay:1e3,maxDelay:3e4,jitter:!0,timeout:0,onOpen:()=>null,onConnect:()=>null,onMessage:()=>null,onOutgoingMessage:()=>null,onStatus:()=>null,onDisconnect:()=>null,onClose:()=>null,onDestroy:()=>null,onAwarenessUpdate:()=>null,onAwarenessChange:()=>null,quiet:!1},this.subscribedToBroadcastChannel=!1,this.webSocket=null,this.shouldConnect=!0,this.status=v.Disconnected,this.lastMessageReceived=0,this.mux=Ii(),this.intervals={forceSync:null,connectionChecker:null},this.connectionAttempt=null,this.receivedOnOpenPayload=void 0,this.receivedOnStatusPayload=void 0,this.boundConnect=this.connect.bind(this),this.setConfiguration(t),this.configuration.WebSocketPolyfill=t.WebSocketPolyfill?t.WebSocketPolyfill:WebSocket,this.on("open",this.configuration.onOpen),this.on("open",this.onOpen.bind(this)),this.on("connect",this.configuration.onConnect),this.on("message",this.configuration.onMessage),this.on("outgoingMessage",this.configuration.onOutgoingMessage),this.on("status",this.configuration.onStatus),this.on("status",this.onStatus.bind(this)),this.on("disconnect",this.configuration.onDisconnect),this.on("close",this.configuration.onClose),this.on("destroy",this.configuration.onDestroy),this.on("awarenessUpdate",this.configuration.onAwarenessUpdate),this.on("awarenessChange",this.configuration.onAwarenessChange),this.on("close",this.onClose.bind(this)),this.on("message",this.onMessage.bind(this)),this.registerEventListeners(),this.intervals.connectionChecker=setInterval(this.checkConnection.bind(this),this.configuration.messageReconnectTimeout/10),typeof t.connect<"u"&&(this.shouldConnect=t.connect),this.shouldConnect&&this.connect()}async onOpen(t){this.receivedOnOpenPayload=t}async onStatus(t){this.receivedOnStatusPayload=t}attach(t){this.receivedOnOpenPayload&&t.onOpen(this.receivedOnOpenPayload),this.receivedOnStatusPayload&&t.onStatus(this.receivedOnStatusPayload)}detach(t){}setConfiguration(t={}){this.configuration={...this.configuration,...t}}async connect(){if(this.status===v.Connected)return;this.cancelWebsocketRetry&&(this.cancelWebsocketRetry(),this.cancelWebsocketRetry=void 0),this.shouldConnect=!0;const t=()=>{let r=!1;return{retryPromise:dh(this.createWebSocketConnection.bind(this),{delay:this.configuration.delay,initialDelay:this.configuration.initialDelay,factor:this.configuration.factor,maxAttempts:this.configuration.maxAttempts,minDelay:this.configuration.minDelay,maxDelay:this.configuration.maxDelay,jitter:this.configuration.jitter,timeout:this.configuration.timeout,beforeAttempt:o=>{(!this.shouldConnect||r)&&o.abort()}}).catch(o=>{if(o&&o.code!=="ATTEMPT_ABORTED")throw o}),cancelFunc:()=>{r=!0}}},{retryPromise:n,cancelFunc:s}=t();return this.cancelWebsocketRetry=s,n}createWebSocketConnection(){return new Promise((t,n)=>{this.webSocket&&(this.webSocket.close(),this.webSocket=null);const s=new this.configuration.WebSocketPolyfill(this.url);s.binaryType="arraybuffer",s.onmessage=r=>this.emit("message",r),s.onclose=r=>this.emit("close",{event:r}),s.onopen=r=>this.emit("open",r),s.onerror=r=>{n(r)},this.webSocket=s,this.status=v.Connecting,this.emit("status",{status:v.Connecting}),this.connectionAttempt={resolve:t,reject:n}})}onMessage(t){this.resolveConnectionAttempt()}resolveConnectionAttempt(){this.connectionAttempt&&(this.connectionAttempt.resolve(),this.connectionAttempt=null,this.status=v.Connected,this.emit("status",{status:v.Connected}),this.emit("connect"))}stopConnectionAttempt(){this.connectionAttempt=null}rejectConnectionAttempt(){var t;(t=this.connectionAttempt)===null||t===void 0||t.reject(),this.connectionAttempt=null}checkConnection(){var t;this.status===v.Connected&&(!this.lastMessageReceived||this.configuration.messageReconnectTimeout>=ue()-this.lastMessageReceived||(t=this.webSocket)===null||t===void 0||t.close())}registerEventListeners(){typeof window>"u"||window.addEventListener("online",this.boundConnect)}get serverUrl(){for(;this.configuration.url[this.configuration.url.length-1]==="/";)return this.configuration.url.slice(0,this.configuration.url.length-1);return this.configuration.url}get url(){const t=wu(this.configuration.parameters);return`${this.serverUrl}${t.length===0?"":`?${t}`}`}disconnect(){if(this.shouldConnect=!1,this.webSocket!==null)try{this.webSocket.close()}catch{}}send(t){var n;((n=this.webSocket)===null||n===void 0?void 0:n.readyState)===Rn.Open&&this.webSocket.send(t)}onClose({event:t}){if(this.webSocket=null,this.status===v.Connected&&(this.status=v.Disconnected,this.emit("status",{status:v.Disconnected}),this.emit("disconnect",{event:t})),t.code===er.code&&(t.reason===er.reason?console.warn("[HocuspocusProvider] An authentication token is required, but you didn’t send one. Try adding a `token` to your HocuspocusProvider configuration. Won’t try again."):console.warn(`[HocuspocusProvider] Connection closed with status Unauthorized: ${t.reason}`),this.shouldConnect=!1),t.code===ah.code&&!this.configuration.quiet){console.warn("[HocuspocusProvider] The provided authentication token isn’t allowed to connect to this server. Will try again.");return}t.code===lh.code&&(console.warn(`[HocuspocusProvider] Connection closed with status MessageTooBig: ${t.reason}`),this.shouldConnect=!1),this.connectionAttempt?this.rejectConnectionAttempt():this.shouldConnect&&this.connect(),!this.shouldConnect&&this.status!==v.Disconnected&&(this.status=v.Disconnected,this.emit("status",{status:v.Disconnected}),this.emit("disconnect",{event:t}))}destroy(){this.emit("destroy"),this.intervals.forceSync&&clearInterval(this.intervals.forceSync),clearInterval(this.intervals.connectionChecker),this.stopConnectionAttempt(),this.disconnect(),this.removeAllListeners(),!(typeof window>"u")&&window.removeEventListener("online",this.boundConnect)}}class bu extends Z{constructor(){super(...arguments),this.type=M.Stateless,this.description="A stateless message"}get(t){var n;return q(this.encoder,t.documentName),U(this.encoder,this.type),q(this.encoder,(n=t.payload)!==null&&n!==void 0?n:""),this.encoder}}class Su extends Z{constructor(){super(...arguments),this.type=M.CLOSE,this.description="Ask the server to close the connection"}get(t){return q(this.encoder,t.documentName),U(this.encoder,this.type),this.encoder}}class ku extends Ui{constructor(t){super(),this.configuration={name:"",document:void 0,awareness:void 0,token:null,parameters:{},broadcast:!0,forceSyncInterval:!1,onAuthenticated:()=>null,onAuthenticationFailed:()=>null,onOpen:()=>null,onConnect:()=>null,onMessage:()=>null,onOutgoingMessage:()=>null,onStatus:()=>null,onSynced:()=>null,onDisconnect:()=>null,onClose:()=>null,onDestroy:()=>null,onAwarenessUpdate:()=>null,onAwarenessChange:()=>null,onStateless:()=>null,quiet:!1},this.subscribedToBroadcastChannel=!1,this.isSynced=!1,this.unsyncedChanges=0,this.status=v.Disconnected,this.isAuthenticated=!1,this.mux=Ii(),this.intervals={forceSync:null},this.isConnected=!0,this.boundBeforeUnload=this.beforeUnload.bind(this),this.boundBroadcastChannelSubscriber=this.broadcastChannelSubscriber.bind(this),this.setConfiguration(t),this.configuration.document=t.document?t.document:new Ct,this.configuration.awareness=t.awareness?t.awareness:new ou(this.document),this.on("open",this.configuration.onOpen),this.on("message",this.configuration.onMessage),this.on("outgoingMessage",this.configuration.onOutgoingMessage),this.on("synced",this.configuration.onSynced),this.on("destroy",this.configuration.onDestroy),this.on("awarenessUpdate",this.configuration.onAwarenessUpdate),this.on("awarenessChange",this.configuration.onAwarenessChange),this.on("stateless",this.configuration.onStateless),this.on("authenticated",this.configuration.onAuthenticated),this.on("authenticationFailed",this.configuration.onAuthenticationFailed),this.configuration.websocketProvider.on("connect",this.configuration.onConnect),this.configuration.websocketProvider.on("connect",n=>this.emit("connect",n)),this.configuration.websocketProvider.on("open",this.onOpen.bind(this)),this.configuration.websocketProvider.on("open",n=>this.emit("open",n)),this.configuration.websocketProvider.on("message",this.onMessage.bind(this)),this.configuration.websocketProvider.on("close",this.onClose.bind(this)),this.configuration.websocketProvider.on("close",this.configuration.onClose),this.configuration.websocketProvider.on("close",n=>this.emit("close",n)),this.configuration.websocketProvider.on("status",this.onStatus.bind(this)),this.configuration.websocketProvider.on("disconnect",this.configuration.onDisconnect),this.configuration.websocketProvider.on("disconnect",n=>this.emit("disconnect",n)),this.configuration.websocketProvider.on("destroy",this.configuration.onDestroy),this.configuration.websocketProvider.on("destroy",n=>this.emit("destroy",n)),this.awareness.on("update",()=>{this.emit("awarenessUpdate",{states:nr(this.awareness.getStates())})}),this.awareness.on("change",()=>{this.emit("awarenessChange",{states:nr(this.awareness.getStates())})}),this.document.on("update",this.documentUpdateHandler.bind(this)),this.awareness.on("update",this.awarenessUpdateHandler.bind(this)),this.registerEventListeners(),this.configuration.forceSyncInterval&&(this.intervals.forceSync=setInterval(this.forceSync.bind(this),this.configuration.forceSyncInterval)),this.configuration.websocketProvider.attach(this)}onStatus({status:t}){this.status=t,this.configuration.onStatus({status:t}),this.emit("status",{status:t})}setConfiguration(t={}){if(!t.websocketProvider&&t.url){const n=t;this.configuration.websocketProvider=new yu({url:n.url,parameters:n.parameters})}this.configuration={...this.configuration,...t}}get document(){return this.configuration.document}get awareness(){return this.configuration.awareness}get hasUnsyncedChanges(){return this.unsyncedChanges>0}updateUnsyncedChanges(t=0){this.unsyncedChanges+=t,this.emit("unsyncedChanges",this.unsyncedChanges)}forceSync(){this.send(bn,{document:this.document,documentName:this.configuration.name})}beforeUnload(){Le(this.awareness,[this.document.clientID],"window unload")}registerEventListeners(){typeof window>"u"||window.addEventListener("beforeunload",this.boundBeforeUnload)}sendStateless(t){this.send(bu,{documentName:this.configuration.name,payload:t})}documentUpdateHandler(t,n){n!==this&&(this.updateUnsyncedChanges(1),this.send(mu,{update:t,documentName:this.configuration.name},!0))}awarenessUpdateHandler({added:t,updated:n,removed:s},r){const i=t.concat(n).concat(s);this.send(De,{awareness:this.awareness,clients:i,documentName:this.configuration.name},!0)}get synced(){return this.isSynced}set synced(t){this.isSynced!==t&&(t&&this.unsyncedChanges>0&&this.updateUnsyncedChanges(-1*this.unsyncedChanges),this.isSynced=t,this.emit("synced",{state:t}),this.emit("sync",{state:t}))}receiveStateless(t){this.emit("stateless",{payload:t})}get isAuthenticationRequired(){return!!this.configuration.token&&!this.isAuthenticated}async connect(){return this.configuration.websocketProvider.connect()}disconnect(){this.disconnectBroadcastChannel(),this.configuration.websocketProvider.detach(this)}async onOpen(t){this.isAuthenticated=!1,this.emit("open",{event:t}),this.isAuthenticationRequired&&this.send(pu,{token:await this.getToken(),documentName:this.configuration.name}),this.startSync()}async getToken(){return typeof this.configuration.token=="function"?await this.configuration.token():this.configuration.token}startSync(){this.send(bn,{document:this.document,documentName:this.configuration.name}),this.awareness.getLocalState()!==null&&this.send(De,{awareness:this.awareness,clients:[this.document.clientID],documentName:this.configuration.name})}send(t,n,s=!1){if(!this.isConnected)return;s&&this.mux(()=>{this.broadcast(t,n)});const r=new hr(t,n);this.emit("outgoingMessage",{message:r.message}),r.send(this.configuration.websocketProvider)}onMessage(t){const n=new yn(t.data),s=n.readVarString();s===this.configuration.name&&(n.writeVarString(s),this.emit("message",{event:t,message:new yn(t.data)}),new ar(n).apply(this))}onClose(t){this.isAuthenticated=!1,this.synced=!1,Le(this.awareness,Array.from(this.awareness.getStates().keys()).filter(n=>n!==this.document.clientID),this)}destroy(){this.emit("destroy"),this.intervals.forceSync&&clearInterval(this.intervals.forceSync),Le(this.awareness,[this.document.clientID],"provider destroy"),this.disconnect(),this.awareness.off("update",this.awarenessUpdateHandler),this.document.off("update",this.documentUpdateHandler),this.removeAllListeners(),this.send(Su,{documentName:this.configuration.name}),this.isConnected=!1,!(typeof window>"u")&&window.removeEventListener("beforeunload",this.boundBeforeUnload)}permissionDeniedHandler(t){this.emit("authenticationFailed",{reason:t}),this.isAuthenticated=!1,this.disconnect(),this.status=v.Disconnected}authenticatedHandler(){this.isAuthenticated=!0,this.emit("authenticated"),this.startSync()}get broadcastChannel(){return`${this.configuration.name}`}broadcastChannelSubscriber(t){this.mux(()=>{const n=new yn(t),s=n.readVarString();n.writeVarString(s),new ar(n).setBroadcasted(!0).apply(this,!1)})}subscribeToBroadcastChannel(){this.subscribedToBroadcastChannel||(nu(this.broadcastChannel,this.boundBroadcastChannelSubscriber),this.subscribedToBroadcastChannel=!0),this.mux(()=>{this.broadcast(bn,{document:this.document}),this.broadcast(fu,{document:this.document}),this.broadcast(gu,{document:this.document}),this.broadcast(De,{awareness:this.awareness,clients:[this.document.clientID],document:this.document})})}disconnectBroadcastChannel(){this.send(De,{awareness:this.awareness,clients:[this.document.clientID],states:new Map,documentName:this.configuration.name},!0),this.subscribedToBroadcastChannel&&(su(this.broadcastChannel,this.boundBroadcastChannelSubscriber),this.subscribedToBroadcastChannel=!1)}broadcast(t,n){!this.configuration.broadcast||!this.subscribedToBroadcastChannel||new hr(t,n).broadcast(this.broadcastChannel)}setAwarenessField(t,n){this.awareness.setLocalStateField(t,n)}}const Cu=()=>{let e=!0;return(t,n)=>{if(e){e=!1;try{t()}finally{e=!0}}else n!==void 0&&n()}},_u=/[\uD800-\uDBFF]/,Au=/[\uDC00-\uDFFF]/,Du=(e,t)=>{let n=0,s=0;for(;n<e.length&&n<t.length&&e[n]===t[n];)n++;for(n>0&&_u.test(e[n-1])&&n--;s+n<e.length&&s+n<t.length&&e[e.length-s-1]===t[t.length-s-1];)s++;return s>0&&Au.test(e[e.length-s])&&s--,{index:n,remove:e.length-n-s,insert:t.slice(n,t.length-s)}},Eu=Du,A=new Hn("y-sync"),ut=new Hn("y-undo"),Ee=new Hn("yjs-cursor"),qe=(e,t)=>t===void 0?!e.deleted:t.sv.has(e.id.client)&&t.sv.get(e.id.client)>e.id.clock&&!Pt(t.ds,e.id),Tu=[{light:"#ecd44433",dark:"#ecd444"}],Iu=(e,t,n)=>{if(!e.has(n)){if(e.size<t.length){const s=wt();e.forEach(r=>s.add(r)),t=t.filter(r=>!s.has(r))}e.set(n,Jc(t))}return e.get(n)},Uu=(e,{colors:t=Tu,colorMapping:n=new Map,permanentUserData:s=null,onFirstRender:r=()=>{}}={})=>{let i=!1,o;const c=new Jn({props:{editable:l=>{const a=A.getState(l);return a.snapshot==null&&a.prevSnapshot==null}},key:A,state:{init:(l,a)=>({type:e,doc:e.doc,binding:null,snapshot:null,prevSnapshot:null,isChangeOrigin:!1,colors:t,colorMapping:n,permanentUserData:s}),apply:(l,a)=>{const h=l.getMeta(A);if(h!==void 0){a=Object.assign({},a);for(const u in h)a[u]=h[u]}return a.isChangeOrigin=h!==void 0&&!!h.isChangeOrigin,a.binding!==null&&h!==void 0&&(h.snapshot!=null||h.prevSnapshot!=null)&&$e(0,()=>{a.binding==null||a.binding.isDestroyed||(h.restore==null?a.binding._renderSnapshot(h.snapshot,h.prevSnapshot,a):(a.binding._renderSnapshot(h.snapshot,h.snapshot,a),delete a.restore,delete a.snapshot,delete a.prevSnapshot,a.binding._prosemirrorChanged(a.binding.prosemirrorView.state.doc)))}),a}},view:l=>{const a=new Mu(e,l);return o!=null&&clearTimeout(o),o=$e(0,()=>{a._forceRerender(),l.dispatch(l.state.tr.setMeta(A,{binding:a})),r()}),{update:()=>{const h=c.getState(l.state);h.snapshot==null&&h.prevSnapshot==null&&(i||l.state.doc.content.findDiffStart(l.state.doc.type.createAndFill().content)!==null)&&(i=!0,a._prosemirrorChanged(l.state.doc))},destroy:()=>{clearTimeout(o),a.destroy()}}}});return c},vu=(e,t,n)=>{if(t!==null&&t.anchor!==null&&t.head!==null){const s=fe(n.doc,n.type,t.anchor,n.mapping),r=fe(n.doc,n.type,t.head,n.mapping);s!==null&&r!==null&&(e=e.setSelection(Bi.create(e.doc,s,r)))}},Pn=(e,t)=>({anchor:Ge(t.selection.anchor,e.type,e.mapping),head:Ge(t.selection.head,e.type,e.mapping)});class Mu{constructor(t,n){this.type=t,this.prosemirrorView=n,this.mux=Cu(),this.isDestroyed=!1,this.mapping=new Map,this._observeFunction=this._typeChanged.bind(this),this.doc=t.doc,this.beforeTransactionSelection=null,this.beforeAllTransactions=()=>{this.beforeTransactionSelection===null&&(this.beforeTransactionSelection=Pn(this,n.state))},this.afterAllTransactions=()=>{this.beforeTransactionSelection=null},this.doc.on("beforeAllTransactions",this.beforeAllTransactions),this.doc.on("afterAllTransactions",this.afterAllTransactions),t.observeDeep(this._observeFunction),this._domSelectionInView=null}get _tr(){return this.prosemirrorView.state.tr.setMeta("addToHistory",!1)}_isLocalCursorInView(){return this.prosemirrorView.hasFocus()?(mc&&this._domSelectionInView===null&&($e(0,()=>{this._domSelectionInView=null}),this._domSelectionInView=this._isDomSelectionInView()),this._domSelectionInView):!1}_isDomSelectionInView(){const t=this.prosemirrorView._root.getSelection(),n=this.prosemirrorView._root.createRange();n.setStart(t.anchorNode,t.anchorOffset),n.setEnd(t.focusNode,t.focusOffset),n.getClientRects().length===0&&n.startContainer&&n.collapsed&&n.selectNodeContents(n.startContainer);const r=n.getBoundingClientRect(),i=ft.documentElement;return r.bottom>=0&&r.right>=0&&r.left<=(window.innerWidth||i.clientWidth||0)&&r.top<=(window.innerHeight||i.clientHeight||0)}renderSnapshot(t,n){n||(n=rs(ts(),new Map)),this.prosemirrorView.dispatch(this._tr.setMeta(A,{snapshot:t,prevSnapshot:n}))}unrenderSnapshot(){this.mapping=new Map,this.mux(()=>{const t=this.type.toArray().map(s=>Re(s,this.prosemirrorView.state.schema,this.mapping)).filter(s=>s!==null),n=this._tr.replace(0,this.prosemirrorView.state.doc.content.size,new be(new Se(t),0,0));n.setMeta(A,{snapshot:null,prevSnapshot:null}),this.prosemirrorView.dispatch(n)})}_forceRerender(){this.mapping=new Map,this.mux(()=>{const t=this.type.toArray().map(s=>Re(s,this.prosemirrorView.state.schema,this.mapping)).filter(s=>s!==null),n=this._tr.replace(0,this.prosemirrorView.state.doc.content.size,new be(new Se(t),0,0));this.prosemirrorView.dispatch(n.setMeta(A,{isChangeOrigin:!0}))})}_renderSnapshot(t,n,s){t||(t=vl(this.doc)),this.mapping=new Map,this.mux(()=>{this.doc.transact(r=>{const i=s.permanentUserData;i&&i.dss.forEach(a=>{ot(r,a,h=>{})});const o=(a,h)=>{const u=a==="added"?i.getUserByClientId(h.client):i.getUserByDeletedId(h);return{user:u,type:a,color:Iu(s.colorMapping,s.colors,u)}},c=Kr(this.type,new ss(n.ds,t.sv)).map(a=>!a._item.deleted||qe(a._item,t)||qe(a._item,n)?Re(a,this.prosemirrorView.state.schema,new Map,t,n,o):null).filter(a=>a!==null),l=this._tr.replace(0,this.prosemirrorView.state.doc.content.size,new be(new Se(c),0,0));this.prosemirrorView.dispatch(l.setMeta(A,{isChangeOrigin:!0}))},A)})}_typeChanged(t,n){const s=A.getState(this.prosemirrorView.state);if(t.length===0||s.snapshot!=null||s.prevSnapshot!=null){this.renderSnapshot(s.snapshot,s.prevSnapshot);return}this.mux(()=>{const r=(c,l)=>this.mapping.delete(l);ot(n,n.deleteSet,c=>c.constructor===k&&this.mapping.delete(c.content.type)),n.changed.forEach(r),n.changedParentTypes.forEach(r);const i=this.type.toArray().map(c=>Oi(c,this.prosemirrorView.state.schema,this.mapping)).filter(c=>c!==null);let o=this._tr.replace(0,this.prosemirrorView.state.doc.content.size,new be(new Se(i),0,0));vu(o,this.beforeTransactionSelection,this),o=o.setMeta(A,{isChangeOrigin:!0}),this.beforeTransactionSelection!==null&&this._isLocalCursorInView()&&o.scrollIntoView(),this.prosemirrorView.dispatch(o)})}_prosemirrorChanged(t){this.mux(()=>{this.doc.transact(()=>{jn(this.doc,this.type,t,this.mapping),this.beforeTransactionSelection=Pn(this,this.prosemirrorView.state)},A)})}destroy(){this.isDestroyed=!0,this.type.unobserveDeep(this._observeFunction),this.doc.off("beforeAllTransactions",this.beforeAllTransactions),this.doc.off("afterAllTransactions",this.afterAllTransactions)}}const Oi=(e,t,n,s,r,i)=>{const o=n.get(e);if(o===void 0){if(e instanceof L)return Re(e,t,n,s,r,i);throw H()}return o},Re=(e,t,n,s,r,i)=>{const o=[],c=l=>{if(l.constructor===L){const a=Oi(l,t,n,s,r,i);a!==null&&o.push(a)}else{const a=xu(l,t,n,s,r,i);a!==null&&a.forEach(h=>{h!==null&&o.push(h)})}};s===void 0||r===void 0?e.toArray().forEach(c):Kr(e,new ss(r.ds,s.sv)).forEach(c);try{const l=e.getAttributes(s);s!==void 0&&(qe(e._item,s)?qe(e._item,r)||(l.ychange=i?i("added",e._item.id):{type:"added"}):l.ychange=i?i("removed",e._item.id):{type:"removed"});const a=t.node(e.nodeName,l,o);return n.set(e,a),a}catch{return e.doc.transact(a=>{e._item.delete(a)},A),n.delete(e),null}},xu=(e,t,n,s,r,i)=>{const o=[],c=e.toDelta(s,r,i);try{for(let l=0;l<c.length;l++){const a=c[l],h=[];for(const u in a.attributes)h.push(t.mark(u,a.attributes[u]));o.push(t.text(a.insert,h))}}catch{return e.doc.transact(a=>{e._item.delete(a)},A),null}return o},Ou=(e,t)=>{const n=new V,s=e.map(r=>({insert:r.text,attributes:Ri(r.marks)}));return n.applyDelta(s),t.set(n,e),n},Lu=(e,t)=>{const n=new L(e.type.name);for(const s in e.attrs){const r=e.attrs[s];r!==null&&s!=="ychange"&&n.setAttribute(s,r)}return n.insert(0,rn(e).map(s=>Fn(s,t))),t.set(n,e),n},Fn=(e,t)=>e instanceof Array?Ou(e,t):Lu(e,t),ur=e=>typeof e=="object"&&e!==null,Ss=(e,t)=>{const n=Object.keys(e).filter(r=>e[r]!==null);let s=n.length===Object.keys(t).filter(r=>t[r]!==null).length;for(let r=0;r<n.length&&s;r++){const i=n[r],o=e[i],c=t[i];s=i==="ychange"||o===c||ur(o)&&ur(c)&&Ss(o,c)}return s},rn=e=>{const t=e.content.content,n=[];for(let s=0;s<t.length;s++){const r=t[s];if(r.isText){const i=[];for(let o=t[s];s<t.length&&o.isText;o=t[++s])i.push(o);s--,n.push(i)}else n.push(r)}return n},Li=(e,t)=>{const n=e.toDelta();return n.length===t.length&&n.every((s,r)=>s.insert===t[r].text&&kr(s.attributes||{}).length===t[r].marks.length&&t[r].marks.every(i=>Ss(s.attributes[i.type.name]||{},i.attrs)))},de=(e,t)=>{if(e instanceof L&&!(t instanceof Array)&&zn(e,t)){const n=rn(t);return e._length===n.length&&Ss(e.getAttributes(),t.attrs)&&e.toArray().every((s,r)=>de(s,n[r]))}return e instanceof V&&t instanceof Array&&Li(e,t)},Ye=(e,t)=>e===t||e instanceof Array&&t instanceof Array&&e.length===t.length&&e.every((n,s)=>t[s]===n),dr=(e,t,n)=>{const s=e.toArray(),r=rn(t),i=r.length,o=s.length,c=gt(o,i);let l=0,a=0,h=!1;for(;l<c;l++){const u=s[l],d=r[l];if(Ye(n.get(u),d))h=!0;else if(!de(u,d))break}for(;l+a<c;a++){const u=s[o-a-1],d=r[i-a-1];if(Ye(n.get(u),d))h=!0;else if(!de(u,d))break}return{equalityFactor:l+a,foundMappedChild:h}},Ru=e=>{let t="",n=e._start;const s={};for(;n!==null;)n.deleted||(n.countable&&n.content instanceof J?t+=n.content.str:n.content instanceof T&&(s[n.content.key]=null)),n=n.right;return{str:t,nAttrs:s}},$u=(e,t,n)=>{n.set(e,t);const{nAttrs:s,str:r}=Ru(e),i=t.map(a=>({insert:a.text,attributes:Object.assign({},s,Ri(a.marks))})),{insert:o,remove:c,index:l}=Eu(r,i.map(a=>a.insert).join(""));e.delete(l,c),e.insert(l,o),e.applyDelta(i.map(a=>({retain:a.insert.length,attributes:a.attributes})))},Ri=e=>{const t={};return e.forEach(n=>{n.type.name!=="ychange"&&(t[n.type.name]=n.attrs)}),t},jn=(e,t,n,s)=>{if(t instanceof L&&t.nodeName!==n.type.name)throw new Error("node name mismatch!");if(s.set(t,n),t instanceof L){const u=t.getAttributes(),d=n.attrs;for(const f in d)d[f]!==null?u[f]!==d[f]&&f!=="ychange"&&t.setAttribute(f,d[f]):t.removeAttribute(f);for(const f in u)d[f]===void 0&&t.removeAttribute(f)}const r=rn(n),i=r.length,o=t.toArray(),c=o.length,l=gt(i,c);let a=0,h=0;for(;a<l;a++){const u=o[a],d=r[a];if(!Ye(s.get(u),d))if(de(u,d))s.set(u,d);else break}for(;h+a+1<l;h++){const u=o[c-h-1],d=r[i-h-1];if(!Ye(s.get(u),d))if(de(u,d))s.set(u,d);else break}e.transact(()=>{for(;c-a-h>0&&i-a-h>0;){const d=o[a],f=r[a],g=o[c-h-1],p=r[i-h-1];if(d instanceof V&&f instanceof Array)Li(d,f)||$u(d,f,s),a+=1;else{let b=d instanceof L&&zn(d,f),S=g instanceof L&&zn(g,p);if(b&&S){const tt=dr(d,f,s),et=dr(g,p,s);tt.foundMappedChild&&!et.foundMappedChild?S=!1:!tt.foundMappedChild&&et.foundMappedChild||tt.equalityFactor<et.equalityFactor?b=!1:S=!1}b?(jn(e,d,f,s),a+=1):S?(jn(e,g,p,s),h+=1):(t.delete(a,1),t.insert(a,[Fn(f,s)]),a+=1)}}const u=c-a-h;if(c===1&&i===0&&o[0]instanceof V?o[0].delete(0,o[0].length):u>0&&t.delete(a,u),a+h<i){const d=[];for(let f=a;f<i-h;f++)d.push(Fn(r[f],s));t.insert(a,d)}},A)},zn=(e,t)=>!(t instanceof Array)&&e.nodeName===t.type.name;let Wt=null;const Nu=()=>{const e=Wt;Wt=null,e.forEach((t,n)=>{const s=n.state.tr,r=A.getState(n.state);r&&r.binding&&!r.binding.isDestroyed&&(t.forEach((i,o)=>{s.setMeta(o,i)}),n.dispatch(s))})},Vu=(e,t,n)=>{Wt||(Wt=new Map,$e(0,Nu)),ct(Wt,e,F).set(t,n)},Ge=(e,t,n)=>{if(e===0)return fn(t,0);let s=t._first===null?null:t._first.content.type;for(;s!==null&&t!==s;){if(s instanceof V){if(s._length>=e)return fn(s,e);if(e-=s._length,s._item!==null&&s._item.next!==null)s=s._item.next.content.type;else{do s=s._item===null?null:s._item.parent,e--;while(s!==t&&s!==null&&s._item!==null&&s._item.next===null);s!==null&&s!==t&&(s=s._item===null?null:s._item.next.content.type)}}else{const r=(n.get(s)||{nodeSize:0}).nodeSize;if(s._first!==null&&e<r)s=s._first.content.type,e--;else{if(e===1&&s._length===0&&r>1)return new se(s._item===null?null:s._item.id,s._item===null?ee(s):null,null);if(e-=r,s._item!==null&&s._item.next!==null)s=s._item.next.content.type;else{if(e===0)return s=s._item===null?s:s._item.parent,new se(s._item===null?null:s._item.id,s._item===null?ee(s):null,null);do s=s._item.parent,e--;while(s!==t&&s._item.next===null);s!==t&&(s=s._item.next.content.type)}}}if(s===null)throw j();if(e===0&&s.constructor!==V&&s!==t)return Bu(s._item.parent,s._item)}return fn(t,t._length)},Bu=(e,t)=>{let n=null,s=null;return e._item===null?s=ee(e):n=m(e._item.id.client,e._item.id.clock),new se(n,s,t.id)},fe=(e,t,n,s)=>{const r=Ul(n,e);if(r===null||r.type!==t&&!ne(t,r.type._item))return null;let i=r.type,o=0;if(i.constructor===V)o=r.index;else if(i._item===null||!i._item.deleted){let c=i._first,l=0;for(;l<i._length&&l<r.index&&c!==null;){if(!c.deleted){const a=c.content.type;l++,a instanceof V?o+=a._length:o+=s.get(a).nodeSize}c=c.right}o+=1}for(;i!==t&&i._item!==null;){const c=i._item.parent;if(c._item===null||!c._item.deleted){o+=1;let l=c._first;for(;l!==null;){const a=l.content.type;if(a===i)break;l.deleted||(a instanceof V?o+=a._length:o+=s.get(a).nodeSize),l=l.right}}i=c}return o-1},Pu=e=>{const t=document.createElement("span");t.classList.add("ProseMirror-yjs-cursor"),t.setAttribute("style",`border-color: ${e.color}`);const n=document.createElement("div");n.setAttribute("style",`background-color: ${e.color}`),n.insertBefore(document.createTextNode(e.name),null);const s=document.createTextNode("⁠"),r=document.createTextNode("⁠");return t.insertBefore(s,null),t.insertBefore(n,null),t.insertBefore(r,null),t},Fu=e=>({style:`background-color: ${e.color}70`,class:"ProseMirror-yjs-selection"}),ju=/^#[0-9a-fA-F]{6}$/,fr=(e,t,n,s)=>{const r=A.getState(e),i=r.doc,o=[];return r.snapshot!=null||r.prevSnapshot!=null||r.binding===null?_s.create(e.doc,[]):(t.getStates().forEach((c,l)=>{if(l!==i.clientID&&c.cursor!=null){const a=c.user||{};a.color==null?a.color="#ffa500":ju.test(a.color)||console.warn("A user uses an unsupported color format",a),a.name==null&&(a.name=`User: ${l}`);let h=fe(i,r.type,Jt(c.cursor.anchor),r.binding.mapping),u=fe(i,r.type,Jt(c.cursor.head),r.binding.mapping);if(h!==null&&u!==null){const d=it(e.doc.content.size-1,0);h=gt(h,d),u=gt(u,d),o.push(As.widget(u,()=>n(a),{key:l+"",side:10}));const f=gt(h,u),g=it(h,u);o.push(As.inline(f,g,s(a),{inclusiveEnd:!0,inclusiveStart:!1}))}}}),_s.create(e.doc,o))},zu=(e,{cursorBuilder:t=Pu,selectionBuilder:n=Fu,getSelection:s=i=>i.selection}={},r="cursor")=>new Jn({key:Ee,state:{init(i,o){return fr(o,e,t,n)},apply(i,o,c,l){const a=A.getState(l),h=i.getMeta(Ee);return a&&a.isChangeOrigin||h&&h.awarenessUpdated?fr(l,e,t,n):o.map(i.mapping,i.doc)}},props:{decorations:i=>Ee.getState(i)},view:i=>{const o=()=>{i.docView&&Vu(i,Ee,{awarenessUpdated:!0})},c=()=>{const l=A.getState(i.state),a=e.getLocalState()||{};if(l.binding!=null)if(i.hasFocus()){const h=s(i.state),u=Ge(h.anchor,l.type,l.binding.mapping),d=Ge(h.head,l.type,l.binding.mapping);(a.cursor==null||!Fs(Jt(a.cursor.anchor),u)||!Fs(Jt(a.cursor.head),d))&&e.setLocalStateField(r,{anchor:u,head:d})}else a.cursor!=null&&fe(l.doc,l.type,Jt(a.cursor.anchor),l.binding.mapping)!==null&&e.setLocalStateField(r,null)};return e.on("change",o),i.dom.addEventListener("focusin",c),i.dom.addEventListener("focusout",c),{update:c,destroy:()=>{i.dom.removeEventListener("focusin",c),i.dom.removeEventListener("focusout",c),e.off("change",o),e.setLocalStateField(r,null)}}}}),Hu=e=>{const t=ut.getState(e).undoManager;if(t!=null)return t.undo(),!0},Ju=e=>{const t=ut.getState(e).undoManager;if(t!=null)return t.redo(),!0},qu=new Set(["paragraph"]),Yu=(e,t)=>!(e instanceof k)||!(e.content instanceof Y)||!(e.content.type instanceof bt||e.content.type instanceof L&&t.has(e.content.type.nodeName))||e.content.type._length===0,Gu=({protectedNodes:e=qu,trackedOrigins:t=[],undoManager:n=null}={})=>new Jn({key:ut,state:{init:(s,r)=>{const i=A.getState(r),o=n||new Nl(i.type,{trackedOrigins:new Set([A].concat(t)),deleteFilter:c=>Yu(c,e)});return{undoManager:o,prevSel:null,hasUndoOps:o.undoStack.length>0,hasRedoOps:o.redoStack.length>0}},apply:(s,r,i,o)=>{const c=A.getState(o).binding,l=r.undoManager,a=l.undoStack.length>0,h=l.redoStack.length>0;return c?{undoManager:l,prevSel:Pn(c,i),hasUndoOps:a,hasRedoOps:h}:a!==r.hasUndoOps||h!==r.hasRedoOps?Object.assign({},r,{hasUndoOps:l.undoStack.length>0,hasRedoOps:l.redoStack.length>0}):r}},view:s=>{const r=A.getState(s.state),i=ut.getState(s.state).undoManager;return i.on("stack-item-added",({stackItem:o})=>{const c=r.binding;c&&o.meta.set(c,ut.getState(s.state).prevSel)}),i.on("stack-item-popped",({stackItem:o})=>{const c=r.binding;c&&(c.beforeTransactionSelection=o.meta.get(c)||c.beforeTransactionSelection)}),{destroy:()=>{i.destroy()}}}}),Wu=wr.create({name:"collaboration",priority:1e3,addOptions(){return{document:null,field:"default",fragment:null}},onCreate(){this.editor.extensionManager.extensions.find(e=>e.name==="history")&&console.warn('[tiptap warn]: "@tiptap/extension-collaboration" comes with its own history support and is not compatible with "@tiptap/extension-history".')},addCommands(){return{undo:()=>({tr:e,state:t,dispatch:n})=>(e.setMeta("preventDispatch",!0),ut.getState(t).undoManager.undoStack.length===0?!1:n?Hu(t):!0),redo:()=>({tr:e,state:t,dispatch:n})=>(e.setMeta("preventDispatch",!0),ut.getState(t).undoManager.redoStack.length===0?!1:n?Ju(t):!0)}},addKeyboardShortcuts(){return{"Mod-z":()=>this.editor.commands.undo(),"Mod-y":()=>this.editor.commands.redo(),"Shift-Mod-z":()=>this.editor.commands.redo()}},addProseMirrorPlugins(){const e=this.options.fragment?this.options.fragment:this.options.document.getXmlFragment(this.options.field),t=Gu(),n=t.spec.view;return t.spec.view=s=>{const{undoManager:r}=ut.getState(s.state);r.restore&&(r.restore(),r.restore=()=>{});const i=n(s);return{destroy:()=>{const o=r.trackedOrigins.has(r),c=r._observers;r.restore=()=>{o&&r.trackedOrigins.add(r),r.doc.on("afterTransaction",r.afterTransactionHandler),r._observers=c},i.destroy()}}},[Uu(e),t]}}),gr=e=>Array.from(e.entries()).map(([t,n])=>({clientId:t,...n.user})),pr=()=>null,Ku=wr.create({name:"collaborationCursor",addOptions(){return{provider:null,user:{name:null,color:null},render:e=>{const t=document.createElement("span");t.classList.add("collaboration-cursor__caret"),t.setAttribute("style",`border-color: ${e.color}`);const n=document.createElement("div");return n.classList.add("collaboration-cursor__label"),n.setAttribute("style",`background-color: ${e.color}`),n.insertBefore(document.createTextNode(e.name),null),t.insertBefore(n,null),t},onUpdate:pr}},onCreate(){this.options.onUpdate!==pr&&console.warn('[tiptap warn]: DEPRECATED: The "onUpdate" option is deprecated. Please use `editor.storage.collaborationCursor.users` instead. Read more: https://tiptap.dev/api/extensions/collaboration-cursor')},addStorage(){return{users:[]}},addCommands(){return{updateUser:e=>()=>(this.options.user=e,this.options.provider.awareness.setLocalStateField("user",this.options.user),!0),user:e=>({editor:t})=>(console.warn('[tiptap warn]: DEPRECATED: The "user" command is deprecated. Please use "updateUser" instead. Read more: https://tiptap.dev/api/extensions/collaboration-cursor'),t.commands.updateUser(e))}},addProseMirrorPlugins(){return[zu((()=>(this.options.provider.awareness.setLocalStateField("user",this.options.user),this.storage.users=gr(this.options.provider.awareness.states),this.options.provider.awareness.on("update",()=>{this.storage.users=gr(this.options.provider.awareness.states)}),this.options.provider.awareness))(),{cursorBuilder:this.options.render})]}});class Xu extends Pi{constructor(){super(...arguments),this.contentComponent=null}}const Qu=({renderers:e})=>z.createElement(z.Fragment,null,Object.entries(e).map(([t,n])=>qo.createPortal(n.reactElement,n.element,t)));class Zu extends z.Component{constructor(t){super(t),this.editorContentRef=z.createRef(),this.initialized=!1,this.state={renderers:{}}}componentDidMount(){this.init()}componentDidUpdate(){this.init()}init(){const{editor:t}=this.props;if(t&&t.options.element){if(t.contentComponent)return;const n=this.editorContentRef.current;n.append(...t.options.element.childNodes),t.setOptions({element:n}),t.contentComponent=this,t.createNodeViews(),this.initialized=!0}}maybeFlushSync(t){this.initialized?Jo.exports.flushSync(t):t()}setRenderer(t,n){this.maybeFlushSync(()=>{this.setState(({renderers:s})=>({renderers:{...s,[t]:n}}))})}removeRenderer(t){this.maybeFlushSync(()=>{this.setState(({renderers:n})=>{const s={...n};return delete s[t],{renderers:s}})})}componentWillUnmount(){const{editor:t}=this.props;if(!t||(this.initialized=!1,t.isDestroyed||t.view.setProps({nodeViews:{}}),t.contentComponent=null,!t.options.element.firstChild))return;const n=document.createElement("div");n.append(...t.options.element.childNodes),t.setOptions({element:n})}render(){const{editor:t,...n}=this.props;return z.createElement(z.Fragment,null,z.createElement("div",{ref:this.editorContentRef,...n}),z.createElement(Qu,{renderers:this.state.renderers}))}}const td=z.memo(Zu),ed=E.exports.createContext({onDragStart:void 0}),nd=()=>E.exports.useContext(ed);z.forwardRef((e,t)=>{const{onDragStart:n}=nd(),s=e.as||"div";return z.createElement(s,{...e,ref:t,"data-node-view-wrapper":"",onDragStart:n,style:{whiteSpace:"normal",...e.style}})});function sd(){const[,e]=E.exports.useState(0);return()=>e(t=>t+1)}const rd=(e={},t=[])=>{const[n,s]=E.exports.useState(null),r=sd(),{onBeforeCreate:i,onBlur:o,onCreate:c,onDestroy:l,onFocus:a,onSelectionUpdate:h,onTransaction:u,onUpdate:d}=e,f=E.exports.useRef(i),g=E.exports.useRef(o),p=E.exports.useRef(c),b=E.exports.useRef(l),S=E.exports.useRef(a),tt=E.exports.useRef(h),et=E.exports.useRef(u),ks=E.exports.useRef(d);return E.exports.useEffect(()=>{!n||(i&&(n.off("beforeCreate",f.current),n.on("beforeCreate",i),f.current=i),o&&(n.off("blur",g.current),n.on("blur",o),g.current=o),c&&(n.off("create",p.current),n.on("create",c),p.current=c),l&&(n.off("destroy",b.current),n.on("destroy",l),b.current=l),a&&(n.off("focus",S.current),n.on("focus",a),S.current=a),h&&(n.off("selectionUpdate",tt.current),n.on("selectionUpdate",h),tt.current=h),u&&(n.off("transaction",et.current),n.on("transaction",u),et.current=u),d&&(n.off("update",ks.current),n.on("update",d),ks.current=d))},[i,o,c,l,a,h,u,d,n]),E.exports.useEffect(()=>{let Cs=!0;const on=new Xu(e);return s(on),on.on("transaction",()=>{requestAnimationFrame(()=>{requestAnimationFrame(()=>{Cs&&r()})})}),()=>{on.destroy(),Cs=!1}},t),n},id=["#958DF1","#F98181","#FBBC88","#FAF594","#70CFF8","#94FADB","#B9F18D"],od=["Lea Thompson","Cyndi Lauper","Tom Cruise","Madonna","Jerry Hall","Joan Collins","Winona Ryder","Christina Applegate","Alyssa Milano","Molly Ringwald","Ally Sheedy","Debbie Harry","Olivia Newton-John","Elton John","Michael J. Fox","Axl Rose","Emilio Estevez","Ralph Macchio","Rob Lowe","Jennifer Grey","Mickey Rourke","John Cusack","Matthew Broderick","Justine Bateman","Lisa Bonet"],$i=e=>e[Math.floor(Math.random()*e.length)],cd=()=>$i(id),ld=()=>$i(od),Ni="聊天室01",ad=({menuClassName:e,fullscreen:t,onFullscreenChange:n})=>At(Fi,{className:ji(e,{disabled:!1}),children:[C(zi,{}),C(Hi,{}),C(Ji,{}),C(qi,{}),C(Yi,{}),C(ke,{}),C(Gi,{}),C(Wi,{}),C(Ki,{}),C(ke,{}),C(Xi,{}),C(Qi,{}),C(Zi,{}),C(to,{}),C(ke,{}),C(eo,{}),C(no,{}),C(so,{}),C(ke,{}),C(ro,{fullscreen:t,onFullscreenChange:n})]}),Vi=new Ct,mr=new ku({url:"ws://api.nancode.cn",name:Ni,document:Vi}),hd=()=>JSON.parse(localStorage.getItem("currentUser")||"{}")||{name:ld(),color:cd()},_d=()=>{const[e,t]=E.exports.useState(!1),[n,s]=E.exports.useState("connecting"),[r,i]=E.exports.useState(hd),o=rd({extensions:[io,oo,co,lo,ao,ho,uo.extend({addKeyboardShortcuts:()=>({})}).configure({types:["heading","paragraph"]}),fo,go,po,mo,wo,yo,bo,So,ko,Co,_o,Ao,Do,Eo,To,Io.configure({onReadOnlyChecked:()=>!0}),Uo,vo,Mo,xo,Oo,Lo.configure({enableEmoticons:!0,forceFallbackImages:!1,suggestion:Ro}),$o,No,Vo.configure({image:{uploader:Yo}}),Bo.configure({linkify:!0,breaks:!0,tightLists:!0,paste:!0,copy:!1}),Wu.configure({document:Vi}),Ku.configure({provider:mr})]});E.exports.useEffect(()=>{mr.on("status",l=>{s(l.status)})},[]),E.exports.useEffect(()=>{o&&r&&(localStorage.setItem("currentUser",JSON.stringify(r)),o.chain().focus().updateUser(r).run())},[o,r]);const c=E.exports.useCallback(()=>{const l=(window.prompt("Name")||"").trim().substring(0,32);if(l)return i({...r,name:l})},[r]);return At("div",{className:"editor",children:[At("div",{className:"editor__header",children:[C("div",{className:`editor__status editor__status--${n}`,children:n==="connected"?`${o==null?void 0:o.storage.collaborationCursor.users.length} 用户${(o==null?void 0:o.storage.collaborationCursor.users.length)===1,""} 在线 ${Ni}`:"下线"}),At("div",{className:"editor__name",children:["名字：",C("button",{onClick:c,children:r.name||"点击设置名字"})]})]}),At(Po,{editor:o,children:[o&&C(ad,{fullscreen:e,onFullscreenChange:l=>{t(l)}}),At(td,{className:"editor__content",editor:o,children:[o&&C(Fo,{editor:o}),o&&C(jo,{editor:o}),o&&C(zo,{editor:o}),o&&C(Ho,{editor:o})]})]})]})};export{_d as default};
